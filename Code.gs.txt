// Google Apps Script untuk PinjamAlat
// Deploy sebagai Web App dengan Execute as: me, Who has access: Anyone

const SPREADSHEET_ID = "1xjZqhlt6RxFUHtFbkNE_1nqyph1xbA78jtIYz98A6vw";
const DRIVE_FOLDER_ID = "1K5ycuoVqPbONG8nUAwU7CMSRnhR-cu8P";

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const action = e.parameter.action;
    const data = e.postData ? JSON.parse(e.postData.contents) : e.parameter;
    
    let result;
    
    switch(action) {
      case 'login':
        result = loginUser(data);
        break;
      case 'getAlat':
        result = getAllAlat(data);
        break;
      case 'getPeminjaman':
        result = getAllPeminjaman(data);
        break;
      case 'getKategori':
        result = getAllKategori(data);
        break;
      case 'getJurusan':
        result = getAllJurusan();
        break;
      case 'getUsers':
        result = getAllUsers();
        break;
      case 'getSettings':
        result = getSettings();
        break;
      case 'saveAlat':
        result = saveAlat(data);
        break;
      case 'savePeminjaman':
        result = savePeminjaman(data);
        break;
      case 'saveKategori':
        result = saveKategori(data);
        break;
      case 'saveJurusan':
        result = saveJurusan(data);
        break;
      case 'saveUser':
        result = saveUser(data);
        break;
      case 'saveSettings':
        result = saveSettings(data);
        break;
      case 'updateAlat':
        result = updateAlat(data);
        break;
      case 'updatePeminjaman':
        result = updatePeminjaman(data);
        break;
      case 'deleteAlat':
        result = deleteAlat(data);
        break;
      case 'deleteKategori':
        result = deleteKategori(data);
        break;
      case 'deleteJurusan':
        result = deleteJurusan(data);
        break;
      case 'deleteUser':
        result = deleteUser(data);
        break;
      case 'uploadFoto':
        result = uploadFotoToDrive(data);
        break;
      default:
        result = { success: false, message: 'Action not found' };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ================== FUNGSI UTAMA ==================

function loginUser(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const usersSheet = ss.getSheetByName('Users');
  const lastRow = usersSheet.getLastRow();
  const lastCol = usersSheet.getLastColumn();
  const usersData = usersSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  
  const username = data.username;
  const password = data.password;
  
  for(let i = 0; i < usersData.length; i++) {
    const user = usersData[i];
    if(user[1] === username && user[2] === password) {
      return {
        success: true,
        user: {
          id: user[0],
          username: user[1],
          password: user[2],
          nama_lengkap: user[3],
          role: user[4],
          jurusan_id: user[5]
        }
      };
    }
  }
  
  return { success: false, message: 'Username atau password salah' };
}

function getAllAlat(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const alatSheet = ss.getSheetByName('Alat');
  const lastRow = alatSheet.getLastRow();
  const lastCol = alatSheet.getLastColumn();
  
  if(lastRow < 2) return { success: true, data: [] };
  
  const alatData = alatSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  const jurusan = getAllJurusan().data;
  const kategori = getAllKategori({}).data;
  
  const alat = alatData.map(row => {
    // Filter berdasarkan jurusan jika user bukan superuser
    if(data.userRole !== 'superuser' && data.jurusanId && row[9] != data.jurusanId) {
      return null;
    }
    
    const jurusanData = jurusan.find(j => j.id == row[9]);
    const kategoriData = kategori.find(k => k.id == row[2]);
    
    return {
      id: row[0],
      kode_seri: row[1],
      nama: row[2],
      kategori_id: row[3],
      jumlah_total: row[4],
      jumlah_tersedia: row[5],
      kondisi: row[6],
      tanggal_masuk: row[7] ? new Date(row[7]).toISOString().split('T')[0] : null,
      keterangan: row[8],
      jurusan_id: row[9],
      foto: row[10],
      jurusan_nama: jurusanData ? jurusanData.nama : '',
      kategori_nama: kategoriData ? kategoriData.nama : ''
    };
  }).filter(item => item !== null);
  
  return { success: true, data: alat };
}

function getAllPeminjaman(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const peminjamanSheet = ss.getSheetByName('Peminjaman');
  const lastRow = peminjamanSheet.getLastRow();
  const lastCol = peminjamanSheet.getLastColumn();
  
  if(lastRow < 2) return { success: true, data: [] };
  
  const peminjamanData = peminjamanSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  
  const peminjaman = peminjamanData.map(row => {
    // Filter berdasarkan jurusan jika user bukan superuser
    if(data.userRole !== 'superuser' && data.jurusanId && row[10] != data.jurusanId) {
      return null;
    }
    
    return {
      id: row[0],
      nomor_peminjaman: row[1],
      nama_peminjam: row[2],
      nomor_hp: row[3],
      kelas_unit: row[4],
      tanggal_pinjam: row[5] ? new Date(row[5]).toISOString().split('T')[0] : null,
      tanggal_kembali_estimasi: row[6] ? new Date(row[6]).toISOString().split('T')[0] : null,
      tanggal_kembali_aktual: row[7] ? new Date(row[7]).toISOString().split('T')[0] : null,
      status: row[8],
      items: JSON.parse(row[9] || '[]'),
      jurusan_id: row[10],
      created_by: row[11],
      created_at: row[12] ? new Date(row[12]).toISOString() : null
    };
  }).filter(item => item !== null);
  
  return { success: true, data: peminjaman };
}

function getAllKategori(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const kategoriSheet = ss.getSheetByName('Kategori');
  const lastRow = kategoriSheet.getLastRow();
  const lastCol = kategoriSheet.getLastColumn();
  
  if(lastRow < 2) return { success: true, data: [] };
  
  const kategoriData = kategoriSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  
  const kategori = kategoriData.map(row => {
    // Filter berdasarkan jurusan jika user bukan superuser
    if(data.userRole !== 'superuser' && data.jurusanId && row[2] != data.jurusanId) {
      return null;
    }
    
    return {
      id: row[0],
      nama: row[1],
      jurusan_id: row[2],
      created_at: row[3] ? new Date(row[3]).toISOString() : null
    };
  }).filter(item => item !== null);
  
  return { success: true, data: kategori };
}

function getAllJurusan() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const jurusanSheet = ss.getSheetByName('Jurusan');
  const lastRow = jurusanSheet.getLastRow();
  const lastCol = jurusanSheet.getLastColumn();
  
  if(lastRow < 2) return { success: true, data: [] };
  
  const jurusanData = jurusanSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  
  const jurusan = jurusanData.map(row => ({
    id: row[0],
    nama: row[1],
    kode: row[2],
    created_at: row[3] ? new Date(row[3]).toISOString() : null
  }));
  
  return { success: true, data: jurusan };
}

function getAllUsers() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const usersSheet = ss.getSheetByName('Users');
  const lastRow = usersSheet.getLastRow();
  const lastCol = usersSheet.getLastColumn();
  
  if(lastRow < 2) return { success: true, data: [] };
  
  const usersData = usersSheet.getRange(2, 1, lastRow-1, lastCol).getValues();
  
  const users = usersData.map(row => ({
    id: row[0],
    username: row[1],
    password: row[2],
    nama_lengkap: row[3],
    role: row[4],
    jurusan_id: row[5]
  }));
  
  return { success: true, data: users };
}

function getSettings() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const settingsSheet = ss.getSheetByName('Settings');
  const lastRow = settingsSheet.getLastRow();
  
  if(lastRow < 2) return { success: true, data: {} };
  
  const settingsData = settingsSheet.getRange(2, 1, lastRow-1, 2).getValues();
  
  const settings = {};
  settingsData.forEach(row => {
    settings[row[0]] = row[1];
  });
  
  return { success: true, data: settings };
}

function saveAlat(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const alatSheet = ss.getSheetByName('Alat');
  const lastRow = alatSheet.getLastRow();
  
  // Generate ID
  const newId = lastRow === 1 ? 1 : alatSheet.getRange(lastRow, 1).getValue() + 1;
  
  const newRow = [
    newId,
    data.kode_seri,
    data.nama,
    data.kategori_id,
    data.jumlah_total,
    data.jumlah_tersedia,
    data.kondisi,
    new Date(),
    data.keterangan || '',
    data.jurusan_id,
    data.foto || ''
  ];
  
  alatSheet.appendRow(newRow);
  
  return { 
    success: true, 
    message: 'Alat berhasil disimpan',
    id: newId
  };
}

function savePeminjaman(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const peminjamanSheet = ss.getSheetByName('Peminjaman');
  const lastRow = peminjamanSheet.getLastRow();
  
  // Generate ID
  const newId = lastRow === 1 ? 1 : peminjamanSheet.getRange(lastRow, 1).getValue() + 1;
  
  const newRow = [
    newId,
    data.nomor_peminjaman,
    data.nama_peminjam,
    data.nomor_hp || '',
    data.kelas_unit,
    new Date(data.tanggal_pinjam),
    new Date(data.tanggal_kembali_estimasi),
    null, // tanggal_kembali_aktual
    'Dipinjam',
    JSON.stringify(data.items),
    data.jurusan_id,
    data.created_by,
    new Date()
  ];
  
  peminjamanSheet.appendRow(newRow);
  
  // Update ketersediaan alat
  updateStokAlat(data.items, 'decrease');
  
  return { 
    success: true, 
    message: 'Peminjaman berhasil disimpan',
    id: newId
  };
}

function updateStokAlat(items, action) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const alatSheet = ss.getSheetByName('Alat');
  const lastRow = alatSheet.getLastRow();
  
  if(lastRow < 2) return;
  
  const alatData = alatSheet.getRange(2, 1, lastRow-1, 11).getValues();
  
  items.forEach(item => {
    for(let i = 0; i < alatData.length; i++) {
      const row = alatData[i];
      if(row[0] == item.id) {
        const currentStock = row[5]; // kolom jumlah_tersedia
        const newStock = action === 'decrease' ? 
          currentStock - item.jumlah : 
          currentStock + item.jumlah;
        
        // Update di spreadsheet
        alatSheet.getRange(i + 2, 6).setValue(newStock);
        break;
      }
    }
  });
}

function uploadFotoToDrive(data) {
  try {
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const blob = Utilities.newBlob(Utilities.base64Decode(data.base64), data.mimeType, data.filename);
    const file = folder.createFile(blob);
    
    // Set file to be publicly accessible
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      success: true,
      url: file.getUrl(),
      id: file.getId(),
      downloadUrl: `https://drive.google.com/uc?id=${file.getId()}`
    };
  } catch(error) {
    return {
      success: false,
      message: error.toString()
    };
  }
}
