<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinjamAlat | Sistem Manajemen Peminjaman</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library untuk ekspor Excel dan PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ff006e;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --card-bg: rgba(255, 255, 255, 0.95);
            --sidebar-bg: linear-gradient(180deg, #2d2d69 0%, #4361ee 100%);
            --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --gradient-success: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
            --gradient-warning: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
            --gradient-dark: linear-gradient(135deg, #212529 0%, #343a40 100%);
            --gradient-info: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
            --gradient-danger: linear-gradient(135deg, #ff006e 0%, #fb5607 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
            --radius: 16px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7ff 0%, #f0f2ff 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOutToLeft {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-100%);
            }
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .login-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 8px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: var(--gray);
            font-size: 13px;
        }

        .school-logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .school-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            border: 3px solid var(--primary);
            box-shadow: var(--shadow);
        }

        .school-name {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
            margin-top: 5px;
        }

        /* Main App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            padding: 25px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: var(--shadow);
            animation: slideInFromLeft 0.3s ease-out;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
            animation: slideOutToLeft 0.3s ease-out;
        }

        .sidebar-header {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 22px;
        }

        .app-logo-image {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .app-logo i {
            font-size: 24px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-close {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0 15px;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
        }

        .sidebar-menu a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .sidebar-menu i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
            width: calc(100% - 280px);
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--dark);
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            margin-right: 10px;
        }

        .mobile-menu-btn:hover {
            background: var(--gray-light);
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: white;
            padding: 18px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: slideIn 0.5s ease-out;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title {
            flex: 1;
            min-width: 200px;
        }

        .page-title h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 24px;
            color: var(--light);
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .page-title p {
            color: var(--gray);
            font-size: 13px;
            line-height: 1.4;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
            flex-shrink: 0;
        }

        .user-details h3 {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .user-details span {
            font-size: 12px;
            color: var(--gray);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 500;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .stat-card:nth-child(2)::before {
            background: var(--gradient-success);
        }

        .stat-card:nth-child(3)::before {
            background: var(--gradient-warning);
        }

        .stat-card:nth-child(4)::before {
            background: var(--gradient-dark);
        }

        .stat-card:nth-child(5)::before {
            background: var(--gradient-info);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 22px;
            color: white;
            background: var(--gradient-primary);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: var(--gradient-success);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: var(--gradient-warning);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: var(--gradient-dark);
        }

        .stat-card:nth-child(5) .stat-icon {
            background: var(--gradient-info);
        }

        .stat-content h3 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Poppins', sans-serif;
            line-height: 1.2;
        }

        .stat-content p {
            color: var(--gray);
            font-size: 13px;
            line-height: 1.3;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 10px 18px;
            background: none;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
            font-size: 14px;
            flex-shrink: 0;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .tab-btn.active {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 3px;
        }

        /* Table Card */
        .table-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            animation: fadeIn 0.8s ease-out;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 18px;
            line-height: 1.3;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* PERBAIKAN: Container untuk manual return */
        .manual-return-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            justify-content: center;
            white-space: nowrap;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn i {
            font-size: 15px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover,
        .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-info {
            background: var(--gradient-info);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover,
        .btn-outline:active {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 12px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: var(--transition);
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray);
            opacity: 0.7;
        }

        /* Password Toggle */
        .password-input-wrapper {
            position: relative;
        }

        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
            z-index: 10;
        }

        .password-toggle-btn:hover {
            color: var(--primary);
        }

        .password-input-wrapper .form-control {
            padding-right: 45px;
        }


        /* File Input Custom */
        .file-input-container {
            position: relative;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed var(--gray-light);
            border-radius: var(--radius-sm);
            background: var(--light);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .file-input-label:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .file-input-label i {
            font-size: 36px;
            color: var(--light);
            margin-bottom: 10px;
        }

        .file-input-label span {
            font-size: 13px;
            color: var(--gray);
        }

        .logo-preview-container {
            text-align: center;
            margin-top: 15px;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--gray-light);
            margin: 0 auto;
        }

        .logo-preview-small {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            animation: fadeIn 0.3s ease-out;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.4s ease-out;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--primary--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(2, 192, 218, 0.849);
            z-index: 1;
        }

        .modal-header h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 18px;
            line-height: 1.3;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 22px;
            color: var(--light);
            cursor: pointer;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-close:hover,
        .modal-close:active {
            background: var(--gray-light);
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
            background: var(--gray-light);
        }

        /* PERBAIKAN: Style untuk alat yang akan dipinjam */
        .alat-pinjam-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-light);
        }

        .alat-info {
            flex: 1;
        }

        .alat-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--dark);
        }

        .alat-stock {
            font-size: 12px;
            color: var(--gray);
        }

        .alat-jumlah-input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .alat-total-count {
            font-size: 12px;
            color: var(--primary);
            margin-top: 5px;
            font-weight: 500;
        }

        .remove-alat-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .remove-alat-btn:hover {
            background: #d6005a;
        }

        /* Table Styling */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 600px;
        }

        .table thead {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
        }

        .table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 13px;
            vertical-align: middle;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        /* PERBAIKAN: Style untuk barcode */
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-light);
        }

        .barcode {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        /* PERBAIKAN TERBARU: Style untuk printer thermal yang sudah diperbaiki */
        @media print {
            body * {
                visibility: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            #thermal-print-content,
            #thermal-print-content * {
                visibility: visible !important;
            }

            #thermal-print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 58mm !important;
                min-width: 58mm !important;
                max-width: 58mm !important;
                padding: 2mm !important;
                margin: 0 !important;
                font-size: 11px !important;
                line-height: 1.3 !important;
                font-family: 'Courier New', monospace !important;
                background: white !important;
                color: black !important;
                border: none !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                overflow: visible !important;
            }

            #thermal-print-content table {
                width: 100% !important;
                font-size: 10px !important;
                border-collapse: collapse !important;
            }

            #thermal-print-content td {
                padding: 2px 3px !important;
                border: none !important;
                vertical-align: top !important;
            }

            #thermal-print-content .barcode-container {
                text-align: center !important;
                margin: 3mm 0 !important;
                padding: 0 !important;
                border: none !important;
            }

            #thermal-print-content .barcode {
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
            }

            #thermal-print-content hr {
                border-top: 1px dashed #000 !important;
                margin: 2mm 0 !important;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .badge-success {
            background: rgba(76, 201, 240, 0.15);
            color: #4cc9f0;
        }

        .badge-warning {
            background: rgba(247, 37, 133, 0.15);
            color: #f72585;
        }

        .badge-primary {
            background: rgba(67, 97, 238, 0.15);
            color: #4361ee;
        }

        .badge-info {
            background: rgba(114, 9, 183, 0.15);
            color: #7209b7;
        }

        .badge-danger {
            background: rgba(255, 0, 110, 0.15);
            color: #ff006e;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        /* Thumbnail in table */
        .alat-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            border: 2px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .alat-thumbnail:hover {
            transform: scale(1.5);
            box-shadow: var(--shadow);
            z-index: 10;
            position: relative;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
            font-size: 13px;
        }

        /* Export Options */
        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* Mobile Table Card */
        .mobile-table-card {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: none;
        }

        .mobile-table-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .mobile-table-item:last-child {
            border-bottom: none;
        }

        .mobile-table-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .mobile-table-label {
            font-weight: 500;
            color: var(--gray);
            font-size: 12px;
            min-width: 100px;
        }

        .mobile-table-value {
            color: var(--dark);
            font-size: 13px;
            text-align: right;
            flex: 1;
        }

        /* Overlay untuk sidebar di mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* PERBAIKAN: Detail Peminjaman Modal - Fix visibility */
        #detail-peminjaman-content {
            background: white;
            color: var(--dark);
            padding: 15px;
            border-radius: var(--radius-sm);
        }

        #detail-peminjaman-content p,
        #detail-peminjaman-content div,
        #detail-peminjaman-content span,
        #detail-peminjaman-content strong {
            color: var(--dark) !important;
        }

        #detail-peminjaman-content .detail-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        #detail-peminjaman-content .detail-label {
            font-weight: 600;
            color: var(--gray);
        }

        #detail-peminjaman-content .detail-value {
            color: var(--dark);
            font-weight: 500;
        }

        /* PERBAIKAN: Settings Page - Fix form label visibility */
        #settings-page {
            background: transparent;
        }

        #settings-page .form-label {
            color: var(--dark) !important;
            font-weight: 500;
            font-size: 14px;
        }

        #settings-page .form-control {
            background: white;
            color: var(--dark);
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .settings-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .settings-card h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-card h3 i {
            color: var(--primary);
        }

        /* Responsive Styles */
        @media (max-width: 1200px) {
            .sidebar {
                width: 70px;
                padding: 20px 0;
            }

            .sidebar:not(.hidden) {
                width: 250px;
            }

            .sidebar-header {
                padding: 0 15px 20px;
            }

            .app-logo span {
                display: none;
            }

            .sidebar:not(.hidden) .app-logo span {
                display: inline;
            }

            .sidebar-menu a span {
                display: none;
            }

            .sidebar:not(.hidden) .sidebar-menu a span {
                display: inline;
            }

            .sidebar-menu a {
                justify-content: center;
                padding: 12px;
            }

            .sidebar:not(.hidden) .sidebar-menu a {
                justify-content: flex-start;
                padding: 14px 20px;
            }

            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
            }

            .sidebar:not(.hidden)+.main-content {
                margin-left: 250px;
                width: calc(100% - 250px);
            }
        }

        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
                margin-bottom: 12px;
            }

            .stat-content h3 {
                font-size: 22px;
            }

            .table-card {
                padding: 15px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .manual-return-container {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .sidebar:not(.hidden) {
                width: 280px;
                transform: translateX(0);
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
                z-index: 1000;
            }

            .sidebar:not(.hidden)+.sidebar-overlay {
                display: block;
            }

            .sidebar-close {
                display: flex;
            }

            .sidebar:not(.hidden) .app-logo span {
                display: inline;
            }

            .sidebar:not(.hidden) .sidebar-menu a span {
                display: inline;
            }

            .sidebar:not(.hidden) .sidebar-menu a {
                justify-content: flex-start;
                padding: 14px 20px;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 15px;
            }

            .top-bar {
                padding: 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .page-title {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .page-title h1 {
                font-size: 20px;
            }

            .user-menu {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
                margin-bottom: 10px;
            }

            .stat-content h3 {
                font-size: 20px;
            }

            .stat-content p {
                font-size: 12px;
            }

            .table-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .table-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .btn {
                padding: 9px 15px;
                font-size: 12px;
            }

            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                width: 100%;
            }

            /* Switch to mobile table view */
            .table-responsive {
                display: none;
            }

            .mobile-table-card {
                display: block;
            }

            .modal-content {
                max-width: 100%;
                max-height: 85vh;
            }

            .modal-body {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .page-title h1 {
                font-size: 18px;
            }

            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .user-details h3 {
                font-size: 14px;
            }

            .table-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .export-options {
                flex-direction: column;
            }

            .export-options .btn {
                width: 100%;
            }

            .sidebar:not(.hidden) {
                width: 100%;
            }

            .settings-card {
                padding: 20px;
            }
        }

        @media (max-width: 360px) {
            .login-card {
                padding: 20px;
            }

            .login-header h1 {
                font-size: 24px;
            }

            .page-title h1 {
                font-size: 16px;
            }

            .stat-content h3 {
                font-size: 18px;
            }
        }

        /* Landscape Mode Optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .login-container {
                padding: 10px;
            }

            .login-card {
                padding: 20px;
            }

            .modal-content {
                max-height: 80vh;
            }

            .sidebar {
                overflow-y: auto;
                padding-top: 60px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #121212;
                color: #f0f0f0;
            }

            .table-card,
            .stat-card,
            .top-bar,
            .modal-content,
            .settings-card,
            .mobile-table-card {
                background: #1e1e1e;
                color: #f0f0f0;
            }

            .page-title h1 {
                color: #f0f0f0 !important;
            }

            .page-title p {
                color: #b0b0b0 !important;
            }

            .mobile-menu-btn {
                color: #f0f0f0 !important;
                background: rgba(255, 255, 255, 0.1);
            }

            .mobile-menu-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .form-control {
                background: #2d2d2d;
                border-color: #404040;
                color: #f0f0f0;
            }

            .form-control::placeholder {
                color: #888;
            }

            .file-input-label {
                background: #2d2d2d;
                border-color: #404040;
            }

            .mobile-table-label {
                color: #b0b0b0 !important;
            }

            .mobile-table-value {
                color: #f0f0f0 !important;
            }

            .table td {
                color: #f0f0f0;
                border-bottom-color: #404040;
            }

            .table tbody tr:hover {
                background: rgba(67, 97, 238, 0.15);
            }

            .form-label {
                color: #f0f0f0 !important;
            }

            .stat-content h3,
            .stat-content p {
                color: #f0f0f0;
            }

            .user-details h3 {
                color: #f0f0f0;
            }

            .table-header h3 {
                color: #f0f0f0;
            }
        }

        /* Additional dark mode for modals */
        @media (prefers-color-scheme: dark) {
            .modal-header {
                background: #2a2a2a !important;
                border-bottom-color: #3a3a3a !important;
            }

            .modal-body {
                background: #1e1e1e !important;
            }

            .modal-footer {
                background: #2a2a2a !important;
                border-top-color: #3a3a3a !important;
            }

            .alat-pinjam-item {
                background: #2a2a2a !important;
                border-color: #3a3a3a !important;
            }

            .alat-name {
                color: #f0f0f0 !important;
            }

            .alat-stock {
                color: #b0b0b0 !important;
            }

            #daftar-alat-pinjam {
                background: #1e1e1e !important;
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }

        .toast.success {
            border-left-color: #4cc9f0;
        }

        .toast.error {
            border-left-color: #ff006e;
        }

        .toast.info {
            border-left-color: #7209b7;
        }

        .toast.warning {
            border-left-color: #f72585;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: #4cc9f0;
        }

        .toast.error .toast-icon {
            color: #ff006e;
        }

        .toast.info .toast-icon {
            color: #7209b7;
        }

        .toast.warning .toast-icon {
            color: #f72585;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .toast-message {
            font-size: 13px;
            color: var(--gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toast-close:hover {
            background: var(--gray-light);
            color: var(--dark);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        /* Dark mode toast */
        @media (prefers-color-scheme: dark) {
            .toast {
                background: #2a2a2a;
            }

            .toast-title {
                color: #f0f0f0;
            }

            .toast-message {
                color: #b0b0b0;
            }
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="school-logo-container">
                <img id="login-school-logo" class="school-logo"
                    src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZs7SGoRoibsRUkeVfMPcmjXotJL7Q0JoXJw6fU6mQt2Ez88VVuY39eJG97DX4_p-WIfwmjAZEvCsvTXu3wYNZOzQpmoPJ6D5pptrlQO8hGOEDclFmEW5Sa6Wq6G0BlE0BjySPARQWLojr3vU2i1x8SunVWuFJv1KCcVv30zaJ8MLZZP1o-6-cdDW0Sa4/s320/smk-02.png"
                    alt="Logo Sekolah">
                <div id="login-school-name" class="school-name">SMKN 1 BUMIJAWA</div>
            </div>
            <div class="login-header">
                <h1>PinjamAlat</h1>
                <p>Sistem Manajemen Peminjaman Peralatan Sekolah</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" class="form-control" placeholder="Masukkan password"
                            required>
                        <button type="button" class="password-toggle-btn" id="password-toggle"
                            onclick="togglePassword()">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="login-text">Masuk ke Sistem</span>
                    <span id="login-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" style="display: none;">
        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner"></div>
            <div id="loading-text">Memproses...</div>
        </div>

        <!-- Overlay untuk sidebar di mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">
                    <img id="sidebar-logo" class="app-logo-image" src="" alt="Logo">
                    <span id="sidebar-school-name">PinjamAlat</span>
                </div>
                <button class="sidebar-close" id="sidebar-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <ul class="sidebar-menu">
                <li><a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a></li>
                <li><a href="#" class="nav-link" data-page="alat">
                        <i class="fas fa-toolbox"></i>
                        <span>Manajemen Alat</span>
                    </a></li>
                <li><a href="#" class="nav-link" data-page="peminjaman">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Peminjaman</span>
                    </a></li>
                <li><a href="#" class="nav-link" data-page="pengembalian">
                        <i class="fas fa-undo-alt"></i>
                        <span>Pengembalian</span>
                    </a></li>
                <li><a href="#" class="nav-link" data-page="riwayat">
                        <i class="fas fa-history"></i>
                        <span>Riwayat</span>
                    </a></li>
                <!-- Kategori bisa diakses semua user -->
                <li><a href="#" class="nav-link" data-page="kategori">
                        <i class="fas fa-tags"></i>
                        <span>Kategori</span>
                    </a></li>
                <!-- Menu berikut hanya untuk Super User -->
                <li><a href="#" class="nav-link superuser-only" data-page="jurusan" style="display: none;">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Jurusan</span>
                    </a></li>
                <li><a href="#" class="nav-link superuser-only" data-page="users" style="display: none;">
                        <i class="fas fa-users"></i>
                        <span>Manajemen User</span>
                    </a></li>
                <li><a href="#" class="nav-link superuser-only" data-page="settings" style="display: none;">
                        <i class="fas fa-cog"></i>
                        <span>Pengaturan</span>
                    </a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">
                    <button class="mobile-menu-btn" id="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 id="page-title">Dashboard</h1>
                        <p id="page-subtitle">Selamat datang di sistem peminjaman alat</p>
                    </div>
                </div>

                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <div class="user-details">
                            <h3 id="user-fullname">User Name</h3>
                            <span id="user-role">Role</span>
                        </div>
                    </div>
                    <button id="logout-btn" class="btn btn-outline btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-alat">0</h3>
                            <p>Total Alat Tersedia</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-peminjaman">0</h3>
                            <p>Peminjaman Aktif</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="alat-terlambat">0</h3>
                            <p>Alat Terlambat</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="alat-tersedia">0</h3>
                            <p>Siap Dipinjam</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-kategori">0</h3>
                            <p>Kategori Alat</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity - Desktop Table -->
                <div class="table-card">
                    <div class="table-header">
                        <h3>Peminjaman Terbaru</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showPage('peminjaman')">
                                <i class="fas fa-plus"></i> Tambah Peminjaman
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="recent-peminjaman">
                            <thead>
                                <tr>
                                    <th>No. Peminjaman</th>
                                    <th>Nama Peminjam</th>
                                    <th>Tanggal Pinjam</th>
                                    <th>Estimasi Kembali</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Recent Activity - Mobile Cards -->
                    <div class="mobile-table-card" id="recent-peminjaman-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Alat Management Page -->
            <div id="alat-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Manajemen Alat</h3>
                        <div class="table-actions">
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportAlatToExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportAlatToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                            <button class="btn btn-primary" id="tambah-alat-btn">
                                <i class="fas fa-plus"></i> Tambah Alat
                            </button>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>Filter Kategori</label>
                            <select id="filter-kategori" class="form-control" onchange="filterAlatTable()">
                                <option value="all">Semua Kategori</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter Jurusan</label>
                            <select id="filter-jurusan" class="form-control" onchange="filterAlatTable()">
                                <option value="all">Semua Jurusan</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter Kondisi</label>
                            <select id="filter-kondisi" class="form-control" onchange="filterAlatTable()">
                                <option value="all">Semua Kondisi</option>
                                <option value="Baik">Baik</option>
                                <option value="Rusak Ringan">Rusak Ringan</option>
                                <option value="Rusak Berat">Rusak Berat</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter Tersedia</label>
                            <select id="filter-tersedia" class="form-control" onchange="filterAlatTable()">
                                <option value="all">Semua Status</option>
                                <option value="tersedia">Tersedia</option>
                                <option value="dipinjam">Dipinjam</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="search-alat" class="form-control" placeholder="Cari alat..."
                                onkeyup="filterAlatTable()">
                        </div>
                    </div>

                    <!-- Desktop Table -->
                    <div class="table-responsive">
                        <table class="table" id="alat-table">
                            <thead>
                                <tr>
                                    <th>Foto</th>
                                    <th>Kode Seri</th>
                                    <th>Nama Alat</th>
                                    <th>Kategori</th>
                                    <th>Jurusan</th>
                                    <th>Total</th>
                                    <th>Tersedia</th>
                                    <th>Kondisi</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="alat-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 10px;">
                        <div style="font-size: 13px; color: var(--gray);">
                            <span id="alat-count">0</span> alat ditemukan
                        </div>
                        <div class="export-options">
                            <button class="btn btn-success btn-sm" onclick="exportAlatToExcel()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="exportAlatToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Peminjaman Page -->
            <div id="peminjaman-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Peminjaman Alat</h3>
                        <button class="btn btn-primary" id="tambah-peminjaman-btn">
                            <i class="fas fa-plus"></i> Tambah Peminjaman
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="peminjaman-table">
                            <thead>
                                <tr>
                                    <th>No. Peminjaman</th>
                                    <th>Nama Peminjam</th>
                                    <th>Kelas</th>
                                    <th>Tanggal Pinjam</th>
                                    <th>Tanggal Kembali</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="peminjaman-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Pengembalian Page -->
            <div id="pengembalian-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Pengembalian Alat</h3>
                        <div class="table-actions">
                            <div class="manual-return-container">
                                <button class="btn btn-primary" id="input-manual-btn">
                                    <i class="fas fa-keyboard"></i> Input Manual
                                </button>
                                <button class="btn btn-info" id="scan-barcode-btn" onclick="showManualReturnModal()">
                                    <i class="fas fa-barcode"></i> Scan Barcode
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="pengembalian-table">
                            <thead>
                                <tr>
                                    <th>No. Peminjaman</th>
                                    <th>Nama Peminjam</th>
                                    <th>Alat</th>
                                    <th>Tanggal Pinjam</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="pengembalian-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Riwayat Page -->
            <div id="riwayat-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Riwayat Peminjaman</h3>
                        <div class="table-actions">
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportRiwayatToExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportRiwayatToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="riwayat-table">
                            <thead>
                                <tr>
                                    <th>No. Peminjaman</th>
                                    <th>Nama Peminjam</th>
                                    <th>Kelas</th>
                                    <th>Alat</th>
                                    <th>Tanggal Pinjam</th>
                                    <th>Tanggal Kembali</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="riwayat-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Kategori Management Page -->
            <div id="kategori-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Manajemen Kategori</h3>
                        <div class="table-actions">
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportKategoriToExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportKategoriToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                            <button class="btn btn-primary" id="tambah-kategori-btn">
                                <i class="fas fa-plus"></i> Tambah Kategori
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="kategori-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Kategori</th>
                                    <th>Jurusan</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah Alat</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="kategori-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Jurusan Management Page -->
            <div id="jurusan-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Manajemen Jurusan</h3>
                        <div class="table-actions">
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportJurusanToExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportJurusanToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                            <button class="btn btn-primary" id="tambah-jurusan-btn">
                                <i class="fas fa-plus"></i> Tambah Jurusan
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="jurusan-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Jurusan</th>
                                    <th>Jumlah Alat</th>
                                    <th>Jumlah Kategori</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="jurusan-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Users Management Page -->
            <div id="users-page" class="page" style="display: none;">
                <div class="table-card">
                    <div class="table-header">
                        <h3>Manajemen Pengguna</h3>
                        <div class="table-actions">
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportUsersToExcel()">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportUsersToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                            <button class="btn btn-primary" id="tambah-user-btn">
                                <i class="fas fa-plus"></i> Tambah Pengguna
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="users-table">
                            <thead>
                                <tr>
                                    <th>Nama Lengkap</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Jurusan</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div class="mobile-table-card" id="users-table-mobile">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page" style="display: none;">
                <div class="settings-grid">
                    <!-- General Settings Card -->
                    <div class="settings-card">
                        <h3><i class="fas fa-cog"></i> Pengaturan Umum</h3>
                        <div class="form-group">
                            <label class="form-label">Nama Aplikasi</label>
                            <input type="text" id="app-name" class="form-control" value="PinjamAlat">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Sekolah</label>
                            <input type="text" id="school-name" class="form-control" value="SMKN 1 BUMIJAWA">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Versi Aplikasi</label>
                            <input type="text" class="form-control" value="1.0.0" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maksimal Durasi Peminjaman (hari)</label>
                            <input type="number" id="max-loan-days" class="form-control" value="7" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notifikasi Peminjaman</label>
                            <select id="notification-setting" class="form-control">
                                <option value="enabled">Aktif</option>
                                <option value="disabled">Nonaktif</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveGeneralSettings()">
                            <i class="fas fa-save"></i> Simpan Pengaturan Umum
                        </button>
                    </div>

                    <!-- Logo Settings Card -->
                    <div class="settings-card">
                        <h3><i class="fas fa-image"></i> Pengaturan Logo</h3>

                        <!-- Current Logo Preview -->
                        <div class="logo-preview-container">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; font-size: 14px; color: var(--gray);">Logo Saat Ini</h4>
                                <img id="current-logo-preview" class="logo-preview" src="" alt="Logo Sekolah">
                                <div id="current-logo-name"
                                    style="margin-top: 10px; font-size: 13px; color: var(--gray);"></div>
                            </div>
                        </div>

                        <!-- Logo Upload -->
                        <div class="form-group">
                            <label class="form-label">Unggah Logo Baru</label>
                            <div class="file-input-container">
                                <input type="file" id="logo-upload" class="file-input" accept="image/*"
                                    onchange="previewLogo(event)">
                                <label for="logo-upload" class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Klik untuk memilih logo<br>Format: JPG, PNG, SVG (max: 2MB)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Logo URL Input -->
                        <div class="form-group">
                            <label class="form-label">Logo Sekolah</label>
                            <input type="url" id="logo-url" class="form-control"
                                placeholder="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZs7SGoRoibsRUkeVfMPcmjXotJL7Q0JoXJw6fU6mQt2Ez88VVuY39eJG97DX4_p-WIfwmjAZEvCsvTXu3wYNZOzQpmoPJ6D5pptrlQO8hGOEDclFmEW5Sa6Wq6G0BlE0BjySPARQWLojr3vU2i1x8SunVWuFJv1KCcVv30zaJ8MLZZP1o-6-cdDW0Sa4/s320/smk-02.png"
                                onchange="previewLogoUrl(this.value)">
                            <small style="color: var(--gray); font-size: 12px;">Masukkan URL gambar langsung (akhiran
                                .jpg, .png, .svg)</small>
                        </div>

                        <!-- New Logo Preview -->
                        <div class="logo-preview-container" id="new-logo-preview-container" style="display: none;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; font-size: 14px; color: var(--gray);">Pratinjau Logo
                                    Baru</h4>
                                <img id="new-logo-preview" class="logo-preview" src="" alt="Logo Baru">
                            </div>
                        </div>

                        <!-- Logo Options -->
                        <div class="form-group">
                            <label class="form-label">Ukuran Logo</label>
                            <select id="logo-size" class="form-control">
                                <option value="small">Kecil</option>
                                <option value="medium" selected>Sedang</option>
                                <option value="large">Besar</option>
                            </select>
                        </div>

                        <!-- Default Logo Option -->
                        <div class="form-group">
                            <label class="form-label">Logo Default</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-outline btn-sm" onclick="setDefaultLogo('logo1')">
                                    <i class="fas fa-tools"></i> Logo 1
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="setDefaultLogo('logo2')">
                                    <i class="fas fa-graduation-cap"></i> Logo 2
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="setDefaultLogo('logo3')">
                                    <i class="fas fa-school"></i> Logo 3
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="setDefaultLogo('remove')">
                                    <i class="fas fa-trash"></i> Hapus Logo
                                </button>
                            </div>
                        </div>

                        <!-- Save Logo Button -->
                        <button class="btn btn-primary" onclick="saveLogo()" style="width: 100%;">
                            <i class="fas fa-save"></i> Simpan Logo
                        </button>
                    </div>

                    <!-- System Information Card -->
                    <div class="settings-card">
                        <h3><i class="fas fa-info-circle"></i> Informasi Sistem</h3>
                        <div class="form-group">
                            <label class="form-label">Pengembang</label>
                            <input type="text" class="form-control" value="Tim Pengembangan Sekolah" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Rilis</label>
                            <input type="text" class="form-control" value="Januari 2024" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lisensi</label>
                            <input type="text" class="form-control" value="Edukasi - Bebas Pakai" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dukungan</label>
                            <input type="text" class="form-control" value="support@sekolah.sch.id" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Panduan Penggunaan</label>
                            <button class="btn btn-outline" onclick="openUserGuide()" style="width: 100%;">
                                <i class="fas fa-book"></i> Buka Panduan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal untuk Form Alat -->
    <div id="alat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-alat-title">Tambah Alat Baru</h3>
                <button class="modal-close" onclick="closeModal('alat-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-alat">
                    <input type="hidden" id="alat-id">
                    <div class="form-group">
                        <label class="form-label">Kode Seri</label>
                        <input type="text" id="alat-kode-seri" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nama Alat</label>
                        <input type="text" id="alat-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategori</label>
                        <select id="alat-kategori" class="form-control" required>
                            <option value="">Pilih Kategori</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jurusan</label>
                        <select id="alat-jurusan" class="form-control" required>
                            <option value="">Pilih Jurusan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jumlah Total</label>
                        <input type="number" id="alat-jumlah-total" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jumlah Tersedia</label>
                        <input type="number" id="alat-jumlah-tersedia" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kondisi</label>
                        <select id="alat-kondisi" class="form-control" required>
                            <option value="Baik">Baik</option>
                            <option value="Rusak Ringan">Rusak Ringan</option>
                            <option value="Rusak Berat">Rusak Berat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Foto Alat (Opsional)</label>
                        <input type="file" id="alat-foto" class="form-control" accept="image/*"
                            onchange="previewFotoAlat(event)">
                        <div id="foto-preview-container" style="display: none; margin-top: 10px;">
                            <img id="foto-preview" src="" alt="Preview Foto"
                                style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Keterangan (Opsional)</label>
                        <textarea id="alat-keterangan" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('alat-modal')">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form Peminjaman -->
    <div id="peminjaman-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Form Peminjaman</h3>
                <button class="modal-close" onclick="closeModal('peminjaman-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-peminjaman">
                    <div class="form-group">
                        <label class="form-label">Nama Peminjam</label>
                        <input type="text" id="peminjam-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kelas/Jurusan</label>
                        <input type="text" id="peminjam-kelas" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nomor HP (Opsional)</label>
                        <input type="text" id="peminjam-nomor-hp" class="form-control" placeholder="08xxxxxxxxxx">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Jurusan Alat</label>
                        <select id="peminjaman-jurusan" class="form-control" onchange="updateAlatDropdown()">
                            <option value="">Pilih Jurusan...</option>
                        </select>
                    </div>

                    <!-- Container untuk alat yang dipinjam -->
                    <div class="form-group">
                        <label class="form-label">Pilih Alat</label>
                        <select id="alat-pilihan" class="form-control" onchange="tambahAlatKeDaftarPinjam()">
                            <option value="">Pilih Alat...</option>
                        </select>
                    </div>

                    <!-- Daftar alat yang akan dipinjam -->
                    <div class="form-group">
                        <label class="form-label">Alat yang Akan Dipinjam</label>
                        <div id="daftar-alat-pinjam">
                            <!-- Alat akan ditambahkan di sini -->
                        </div>
                        <div id="total-alat-dipinjam" class="alat-total-count" style="display: none;">
                            Total: <span id="total-jumlah-alat">0</span> alat
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tanggal Pengembalian (Estimasi)</label>
                        <input type="date" id="peminjaman-tanggal-kembali" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Keperluan (Opsional)</label>
                        <textarea id="peminjaman-keperluan" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('peminjaman-modal')">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan Peminjaman
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Pengembalian Manual -->
    <div id="manual-return-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pengembalian Manual</h3>
                <button class="modal-close" onclick="closeModal('manual-return-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-manual-return">
                    <div class="form-group">
                        <label class="form-label">Pilih Peminjaman</label>
                        <select id="select-peminjaman" class="form-control" required>
                            <option value="">Pilih peminjaman...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kondisi Alat Saat Dikembalikan</label>
                        <select id="kondisi-kembali" class="form-control" required>
                            <option value="Baik">Baik</option>
                            <option value="Rusak Ringan">Rusak Ringan</option>
                            <option value="Rusak Berat">Rusak Berat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Keterangan (Opsional)</label>
                        <textarea id="keterangan-kembali" class="form-control" rows="3"
                            placeholder="Catatan kondisi alat..."></textarea>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('manual-return-modal')">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Proses Pengembalian
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Detail Peminjaman dengan Barcode -->
    <div id="detail-peminjaman-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detail Peminjaman</h3>
                <button class="modal-close" onclick="closeModal('detail-peminjaman-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="detail-peminjaman-content">
                    <!-- Detail akan diisi oleh JavaScript -->
                </div>
                <div class="barcode-container" id="barcode-container">
                    <svg id="barcode"></svg>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printThermal()" id="print-thermal-btn">
                        <i class="fas fa-print"></i> Cetak ke Printer Thermal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form Kategori -->
    <div id="kategori-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-kategori-title">Tambah Kategori Baru</h3>
                <button class="modal-close" onclick="closeModal('kategori-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-kategori">
                    <input type="hidden" id="kategori-id">
                    <div class="form-group">
                        <label class="form-label">Nama Kategori</label>
                        <input type="text" id="kategori-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jurusan</label>
                        <select id="kategori-jurusan" class="form-control" required>
                            <option value="">Pilih Jurusan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deskripsi (Opsional)</label>
                        <textarea id="kategori-deskripsi" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('kategori-modal')">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form Jurusan -->
    <div id="jurusan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-jurusan-title">Tambah Jurusan Baru</h3>
                <button class="modal-close" onclick="closeModal('jurusan-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-jurusan">
                    <input type="hidden" id="jurusan-id">
                    <div class="form-group">
                        <label class="form-label">Nama Jurusan</label>
                        <input type="text" id="jurusan-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kode Jurusan</label>
                        <input type="text" id="jurusan-kode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deskripsi (Opsional)</label>
                        <textarea id="jurusan-deskripsi" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('jurusan-modal')">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Form User -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-user-title">Tambah Pengguna Baru</h3>
                <button class="modal-close" onclick="closeModal('user-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-user">
                    <input type="hidden" id="user-id">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" id="user-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="user-username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="user-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="form-user-role" class="form-control" required>
                            <option value="">Pilih Role</option>
                            <option value="guru">Guru</option>
                            <option value="superuser">Super User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jurusan (untuk Guru)</label>
                        <select id="user-jurusan" class="form-control">
                            <option value="">Pilih Jurusan</option>
                        </select>
                    </div>
                    <div class="form-group" style="text-align: right;">
                        <button type="button" class="btn btn-outline" onclick="closeModal('user-modal')">
                            Batal
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveUser()">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal untuk Kamera (untuk scan barcode) -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Scan Barcode</h3>
                <button class="modal-close" onclick="closeModal('camera-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="camera-container" style="text-align: center;">
                    <video id="camera-preview" width="100%" style="border-radius: var(--radius-sm);"></video>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="startCamera()">
                            <i class="fas fa-camera"></i> Aktifkan Kamera
                        </button>
                        <button class="btn btn-danger" onclick="stopCamera()" style="display: none;">
                            <i class="fas fa-stop"></i> Matikan Kamera
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container untuk cetak thermal (TIDAK DISEMBUNYIKAN, tapi diatur posisinya di luar layar) -->
    <div id="thermal-print-content"
        style="position: fixed; left: -9999px; top: -9999px; width: 58mm; font-family: 'Courier New', monospace; font-size: 9px; line-height: 1.1; background: white; padding: 2mm;">
        <!-- Konten thermal akan diisi oleh JavaScript -->
    </div>

    <script>
        // ================== VARIABEL GLOBAL ==================
        let currentUser = null;
        let alat = [];
        let peminjaman = [];
        let kategori = [];
        let users = [];
        let jurusan = [];
        let settings = {};
        let stream = null; // Untuk kamera

        // Array untuk menyimpan alat yang akan dipinjam
        let alatDipinjam = [];

        // OPTIMASI: Background save queue
        let saveQueue = [];
        let saveTimeout = null;
        const SAVE_DELAY = 30000; // 30 detik

        // ================== API CONFIGURATION ==================
        const API_URL = "https://script.google.com/macros/s/AKfycbyGA7Uc9spAOVt_cDaWRR8pYosCGiWB0KH1T7zf04JO9ujUzNb3XYksr6c9dDO9vbxM/exec";
        const DEFAULT_LOGO_URL = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZs7SGoRoibsRUkeVfMPcmjXotJL7Q0JoXJw6fU6mQt2Ez88VVuY39eJG97DX4_p-WIfwmjAZEvCsvTXu3wYNZOzQpmoPJ6D5pptrlQO8hGOEDclFmEW5Sa6Wq6G0BlE0BjySPARQWLojr3vU2i1x8SunVWuFJv1KCcVv30zaJ8MLZZP1o-6-cdDW0Sa4/s320/smk-02.png";

        // ================== TOAST NOTIFICATION SYSTEM ==================
        function showToast(title, message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `
                <i class="fas ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="closeToast(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeToast(toast.querySelector('.toast-close'));
                }, duration);
            }
        }

        function closeToast(button) {
            const toast = button.closest('.toast');
            if (toast) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // ================== BACKGROUND SAVE SYSTEM ==================
        function queueSave(action, data, onSuccess, onError) {
            // Add to queue
            saveQueue.push({ action, data, onSuccess, onError });

            // Clear existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            // Set new timeout
            saveTimeout = setTimeout(() => {
                processSaveQueue();
            }, SAVE_DELAY);

            // Show queued notification
            showToast('Perubahan Tertunda', 'Data akan disimpan otomatis dalam 30 detik', 'info', 3000);
        }

        async function processSaveQueue() {
            if (saveQueue.length === 0) return;

            showToast('Menyimpan Data', 'Sedang menyimpan perubahan...', 'info', 0);

            const queue = [...saveQueue];
            saveQueue = [];

            let successCount = 0;
            let errorCount = 0;

            for (const item of queue) {
                try {
                    const result = await saveDataToSpreadsheet(item.action, item.data);
                    if (result.success) {
                        successCount++;
                        if (item.onSuccess) item.onSuccess(result);
                    } else {
                        errorCount++;
                        if (item.onError) item.onError(result);
                    }
                } catch (error) {
                    errorCount++;
                    if (item.onError) item.onError(error);
                }
            }

            // Close loading toast
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(t => {
                if (t.querySelector('.toast-title')?.textContent === 'Menyimpan Data') {
                    closeToast(t.querySelector('.toast-close'));
                }
            });

            // Show result
            if (errorCount === 0) {
                showToast('Berhasil!', `${successCount} perubahan berhasil disimpan`, 'success');
            } else if (successCount === 0) {
                showToast('Gagal!', `${errorCount} perubahan gagal disimpan`, 'error');
            } else {
                showToast('Sebagian Berhasil', `${successCount} berhasil, ${errorCount} gagal`, 'warning');
            }
        }

        // Force save immediately
        function forceSave() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            processSaveQueue();
        }

        // ================== API CONFIGURATION (LEGACY) ==================

        // ================== FUNGSI API CALL ==================
        async function callAPI(action, data = {}) {
            try {
                const payload = {
                    action: action,
                    data: data
                };

                showLoading(`Memproses ${action}...`);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(payload)
                });

                hideLoading();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('API Error:', error);
                hideLoading();
                alert('Koneksi gagal: ' + error.message);
                return { success: false, message: 'Koneksi gagal: ' + error.message };
            }
        }

        // Fungsi untuk load data dari spreadsheet
        async function loadDataFromSpreadsheet() {
            try {
                // OPTIMASI: Show non-blocking toast
                showToast('Memuat Data', 'Mengambil data terbaru...', 'info', 2000);

                // Load semua data sekaligus
                const [alatRes, peminjamanRes, kategoriRes, jurusanRes, usersRes, settingsRes] = await Promise.all([
                    loadAlatData(),
                    loadPeminjamanData(),
                    loadKategoriData(),
                    loadJurusanData(),
                    loadUsersData(),
                    loadSettingsData()
                ]);

                if (alatRes.success) alat = alatRes.data;
                if (peminjamanRes.success) peminjaman = peminjamanRes.data;
                if (kategoriRes.success) kategori = kategoriRes.data;
                if (jurusanRes.success) jurusan = jurusanRes.data;
                if (usersRes.success) users = usersRes.data;
                if (settingsRes.success) settings = settingsRes.data;

                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal!', 'Gagal memuat data dari server', 'error');
                return false;
            }
        }

        async function loadAlatData() {
            try {
                const data = {
                    userRole: currentUser?.role,
                    jurusanId: currentUser?.jurusan_id
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getAlat',
                        data: data
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading alat:', error);
                return { success: false, data: [] };
            }
        }

        async function loadPeminjamanData() {
            try {
                const data = {
                    userRole: currentUser?.role,
                    jurusanId: currentUser?.jurusan_id
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getPeminjaman',
                        data: data
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading peminjaman:', error);
                return { success: false, data: [] };
            }
        }

        async function loadKategoriData() {
            try {
                const data = {
                    userRole: currentUser?.role,
                    jurusanId: currentUser?.jurusan_id
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getKategori',
                        data: data
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading kategori:', error);
                return { success: false, data: [] };
            }
        }

        async function loadJurusanData() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getJurusan'
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading jurusan:', error);
                return { success: false, data: [] };
            }
        }

        async function loadUsersData() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getUsers'
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading users:', error);
                return { success: false, data: [] };
            }
        }

        async function loadSettingsData() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'getSettings'
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error loading settings:', error);
                return { success: false, data: {} };
            }
        }

        async function saveDataToSpreadsheet(action, data) {
            try {
                // OPTIMASI: Show non-blocking toast instead of blocking loading
                showToast('Menyimpan...', 'Sedang memproses data', 'info', 2000);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();

                if (result.success) {
                    // Refresh data setelah save
                    await loadDataFromSpreadsheet();

                    // OPTIMASI: Show success toast
                    showToast('Berhasil!', 'Data berhasil disimpan', 'success');

                    return result;
                } else {
                    throw new Error(result.message || 'Gagal menyimpan data');
                }
            } catch (error) {
                console.error('Error saving data:', error);

                // OPTIMASI: Show error toast
                showToast('Gagal!', 'Gagal menyimpan data: ' + error.message, 'error');

                return { success: false, message: error.message };
            }
        }

        async function uploadFoto(file) {
            try {
                showLoading('Mengunggah foto...');

                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async function (e) {
                        const base64 = e.target.result.split(',')[1];
                        const data = {
                            base64: base64,
                            mimeType: file.type,
                            filename: file.name
                        };

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain'
                            },
                            body: JSON.stringify({
                                action: 'uploadFoto',
                                data: data
                            })
                        });

                        if (!response.ok) throw new Error('Network response was not ok');

                        const result = await response.json();
                        hideLoading();

                        if (result.success) {
                            resolve(result);
                        } else {
                            reject(new Error(result.message));
                        }
                    };
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('Error uploading photo:', error);
                hideLoading();
                throw error;
            }
        }

        // ================== FUNGSI CETAK THERMAL ==================
        function prepareThermalContent(peminjamanData) {
            if (!peminjamanData) return '';

            // Format tanggal untuk thermal
            const formatDateThermal = (dateString) => {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            // Cari data alat
            let alatList = '';
            if (peminjamanData.items && peminjamanData.items.length > 0) {
                peminjamanData.items.forEach(item => {
                    const alatData = alat.find(a => a.id == item.id);
                    if (alatData) {
                        // Potong nama alat jika terlalu panjang
                        let namaAlat = alatData.nama;
                        if (namaAlat.length > 18) {
                            namaAlat = namaAlat.substring(0, 15) + '...';
                        }
                        alatList += `<tr>
                            <td>${namaAlat}</td>
                            <td align="right">x${item.jumlah}</td>
                        </tr>`;
                    }
                });
            }

            // Generate nomor peminjaman pendek untuk barcode
            const barcodeText = peminjamanData.nomor_peminjaman.replace(/-/g, '');

            // Buat canvas untuk barcode
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 50;

            // Generate barcode ke canvas
            JsBarcode(canvas, barcodeText, {
                format: "CODE128",
                width: 1.5,
                height: 40,
                displayValue: false,
                margin: 0
            });

            const barcodeDataUrl = canvas.toDataURL('image/png');

            // Buat konten HTML untuk thermal
            return `
                <div style="text-align: center; margin-bottom: 2mm;">
                    <div style="font-weight: bold; font-size: 10px;">BUKTI PEMINJAMAN ALAT</div>
                    <div style="font-size: 8px;">${settings.schoolName || 'SMKN 1 BUMIJAWA'}</div>
                </div>
                <hr>
                <table width="100%" cellpadding="0" cellspacing="0" style="font-size: 10px;">
                    <tr>
                        <td width="40%"><strong>No. Pinjam:</strong></td>
                        <td>${peminjamanData.nomor_peminjaman}</td>
                    </tr>
                    <tr>
                        <td><strong>Nama:</strong></td>
                        <td>${peminjamanData.nama_peminjam}</td>
                    </tr>
                    <tr>
                        <td><strong>Kelas:</strong></td>
                        <td>${peminjamanData.kelas_unit}</td>
                    </tr>
                    <tr>
                        <td><strong>Tgl Pinjam:</strong></td>
                        <td>${formatDateThermal(peminjamanData.tanggal_pinjam)}</td>
                    </tr>
                    <tr>
                        <td><strong>Tgl Kembali:</strong></td>
                        <td>${formatDateThermal(peminjamanData.tanggal_kembali_estimasi)}</td>
                    </tr>
                </table>
                <hr>
                <div style="margin-bottom: 2mm;"><strong>Alat yang Dipinjam:</strong></div>
                <table width="100%" cellpadding="0" cellspacing="0" style="font-size: 10px;">
                    ${alatList}
                </table>
                <hr>
                <div style="text-align: center; margin: 3mm 0;">
                    <img src="${barcodeDataUrl}" style="width: 100%; height: auto; max-width: 200px;">
                    <div style="font-size: 7px; margin-top: 1mm;">${barcodeText}</div>
                </div>
                <hr>
                <div style="text-align: center; font-size: 9px; margin-top: 3mm;">
                    <div>Simpan bukti ini untuk pengembalian</div>
                    <div>Terima kasih</div>
                </div>
                <div style="text-align: center; font-size: 8px; margin-top: 5mm;">
                    ${new Date().toLocaleString('id-ID')}
                </div>
            `;
        }

        function showDetailPeminjamanWithBarcode(id) {
            const peminjamanData = peminjaman.find(p => p.id == id);
            if (!peminjamanData) return;

            // Simpan ID untuk print
            window.currentPrintId = id;

            // Isi detail modal
            const detailContent = document.getElementById('detail-peminjaman-content');
            let detailHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>No. Peminjaman:</strong> ${peminjamanData.nomor_peminjaman}</p>
                    <p><strong>Nama Peminjam:</strong> ${peminjamanData.nama_peminjam}</p>
                    <p><strong>Kelas:</strong> ${peminjamanData.kelas_unit}</p>
                    <p><strong>Tanggal Pinjam:</strong> ${formatDate(peminjamanData.tanggal_pinjam)}</p>
                    <p><strong>Estimasi Kembali:</strong> ${formatDate(peminjamanData.tanggal_kembali_estimasi)}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(peminjamanData.status)}">${peminjamanData.status}</span></p>
                </div>
            `;

            // Tambahkan list alat
            if (peminjamanData.items && peminjamanData.items.length > 0) {
                detailHTML += `<p><strong>Alat yang Dipinjam:</strong></p><ul>`;
                peminjamanData.items.forEach(item => {
                    const alatData = alat.find(a => a.id == item.id);
                    if (alatData) {
                        detailHTML += `<li>${alatData.nama} (${alatData.kode_seri}) x${item.jumlah}</li>`;
                    }
                });
                detailHTML += `</ul>`;
            }

            detailContent.innerHTML = detailHTML;

            // Generate barcode untuk modal
            const barcodeContainer = document.getElementById('barcode');
            if (barcodeContainer) {
                barcodeContainer.innerHTML = '';
                JsBarcode("#barcode", peminjamanData.nomor_peminjaman, {
                    format: "CODE128",
                    width: 2,
                    height: 60,
                    displayValue: true,
                    fontSize: 14,
                    margin: 10
                });
            }

            showModal('detail-peminjaman-modal');
        }

        function printThermalSingle(id) {
            window.currentPrintId = id;
            printThermal();
        }

        function printThermal() {
            const peminjamanId = window.currentPrintId;
            if (!peminjamanId) {
                alert('Tidak ada data peminjaman yang dipilih!');
                return;
            }

            const peminjamanData = peminjaman.find(p => p.id == peminjamanId);
            if (!peminjamanData) {
                alert('Data peminjaman tidak ditemukan!');
                return;
            }

            // Siapkan konten untuk thermal
            const thermalContent = prepareThermalContent(peminjamanData);
            const thermalContainer = document.getElementById('thermal-print-content');

            if (!thermalContainer) {
                alert('Container thermal tidak ditemukan!');
                return;
            }

            // Isi konten thermal
            thermalContainer.innerHTML = thermalContent;

            // Tambahkan CSS khusus untuk thermal print
            const style = document.createElement('style');
            style.innerHTML = `
                @media print {
                    body * {
                        visibility: hidden !important;
                        margin: 0 !important;
                        padding: 0 !important;
                    }
                    
                    #thermal-print-content, 
                    #thermal-print-content * {
                        visibility: visible !important;
                    }
                    
                    #thermal-print-content {
                        position: absolute !important;
                        left: 0 !important;
                        top: 0 !important;
                        width: 58mm !important;
                        min-width: 58mm !important;
                        max-width: 58mm !important;
                        padding: 3mm !important;
                        margin: 0 !important;
                        font-size: 11px !important;
                        line-height: 1.3 !important;
                        font-family: 'Courier New', monospace !important;
                        background: white !important;
                        color: black !important;
                        border: none !important;
                        box-shadow: none !important;
                        page-break-inside: avoid !important;
                        overflow: visible !important;
                    }
                    
                    #thermal-print-content table {
                        width: 100% !important;
                        font-size: 10px !important;
                        border-collapse: collapse !important;
                    }
                    
                    #thermal-print-content td {
                        padding: 2px 3px !important;
                        border: none !important;
                        vertical-align: top !important;
                    }
                    
                    #thermal-print-content .barcode-container {
                        text-align: center !important;
                        margin: 3mm 0 !important;
                        padding: 0 !important;
                        border: none !important;
                    }
                    
                    #thermal-print-content .barcode {
                        width: 100% !important;
                        max-width: 100% !important;
                        height: auto !important;
                    }
                    
                    #thermal-print-content hr {
                        border-top: 1px dashed #000 !important;
                        margin: 2mm 0 !important;
                    }
                    
                    .no-print {
                        display: none !important;
                    }
                }
            `;

            document.head.appendChild(style);

            // Delay sedikit sebelum print untuk memastikan konten sudah siap
            setTimeout(() => {
                // Pindahkan container ke posisi yang terlihat untuk print
                thermalContainer.style.position = 'absolute';
                thermalContainer.style.left = '0';
                thermalContainer.style.top = '0';
                thermalContainer.style.fontSize = '11px';

                // Trigger print
                window.print();

                // Setelah print, kembalikan posisi container
                setTimeout(() => {
                    thermalContainer.style.position = 'fixed';
                    thermalContainer.style.left = '-9999px';
                    thermalContainer.style.top = '-9999px';

                    // Hapus style tambahan
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }

                    // Tampilkan konfirmasi
                    alert('Cetak berhasil. Silahkan periksa printer thermal Anda.');
                }, 100);
            }, 500);
        }

        // ================== FUNGSI BANTUAN ==================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Dipinjam': return 'badge-warning';
                case 'Dikembalikan': return 'badge-success';
                case 'Terlambat': return 'badge-danger';
                default: return 'badge-info';
            }
        }

        function getKondisiBadgeClass(kondisi) {
            switch (kondisi) {
                case 'Baik': return 'badge-success';
                case 'Rusak Ringan': return 'badge-warning';
                case 'Rusak Berat': return 'badge-danger';
                default: return 'badge-info';
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            // Stop camera jika sedang aktif
            if (modalId === 'camera-modal') {
                stopCamera();
            }
        }

        function showLoading(text = 'Memproses...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // ================== FUNGSI LOGIN & AUTH ==================
        async function initApp() {
            // Setup event listener untuk form login
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    handleLogin();
                });
            }

            // Setup logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Setup menu navigation
            setupNavigation();

            // Setup mobile menu
            setupMobileMenu();

            // Setup modal buttons
            setupModalButtons();

            // Check if mobile
            checkMobileView();

            // Setup event listeners untuk mobile
            window.addEventListener('resize', checkMobileView);

            // Load initial settings
            loadSettings();

            // PERBAIKAN: Auto-login jika ada session tersimpan
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await autoLogin();
                } catch (error) {
                    console.error('Auto-login error:', error);
                    localStorage.removeItem('currentUser');
                }
            }
        }

        async function autoLogin() {
            // Update UI dengan info user
            document.getElementById('user-fullname').textContent = currentUser.full_name;
            document.getElementById('user-role').textContent = currentUser.role === 'superuser' ? 'Super User' : 'Guru';
            document.getElementById('user-avatar').textContent = currentUser.full_name.charAt(0).toUpperCase();

            // Tampilkan menu superuser jika perlu
            document.querySelectorAll('.superuser-only').forEach(el => {
                el.style.display = currentUser.role === 'superuser' ? 'flex' : 'none';
            });

            // Load data dari spreadsheet
            await loadDataFromSpreadsheet();

            // Update dashboard stats
            updateDashboardStats();

            // Load data tables
            loadDashboardData();
            loadAlatTable();
            loadPeminjamanTable();
            loadRiwayatTable();
            loadKategoriTable();
            loadJurusanTable();
            loadUsersTable();

            // Switch ke halaman app
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Show dashboard
            showPage('dashboard');
        }

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Login loading state
            const loginText = document.getElementById('login-text');
            const loginLoading = document.getElementById('login-loading');

            loginText.style.display = 'none';
            loginLoading.style.display = 'inline';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'login',
                        data: { username, password }
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();

                if (result.success) {
                    // Simpan user yang login
                    currentUser = result.data;

                    // PERBAIKAN: Simpan ke localStorage untuk persistence
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    // Update UI dengan info user
                    document.getElementById('user-fullname').textContent = currentUser.full_name;
                    document.getElementById('user-role').textContent = currentUser.role === 'superuser' ? 'Super User' : 'Guru';
                    document.getElementById('user-avatar').textContent = currentUser.full_name.charAt(0).toUpperCase();

                    // Tampilkan menu superuser jika perlu
                    document.querySelectorAll('.superuser-only').forEach(el => {
                        el.style.display = currentUser.role === 'superuser' ? 'flex' : 'none';
                    });

                    // Load data dari spreadsheet
                    await loadDataFromSpreadsheet();

                    // Update dashboard stats
                    updateDashboardStats();

                    // Load data tables
                    loadDashboardData();
                    loadAlatTable();
                    loadPeminjamanTable();
                    loadRiwayatTable();
                    loadKategoriTable();
                    loadJurusanTable();
                    loadUsersTable();

                    // Switch ke halaman app
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('app').style.display = 'block';

                    // Show dashboard
                    showPage('dashboard');
                } else {
                    alert('Username atau password salah!');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Terjadi kesalahan saat login. Silahkan coba lagi.');
            } finally {
                // Reset loading state
                loginText.style.display = 'inline';
                loginLoading.style.display = 'none';
            }
        }

        function handleLogout() {
            currentUser = null;

            // PERBAIKAN: Hapus dari localStorage
            localStorage.removeItem('currentUser');

            document.getElementById('app').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';

            // Reset form login
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function updateDashboardStats() {
            // Update total alat
            let totalAlat = alat.length;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                totalAlat = alat.filter(a => a.jurusan_id == currentUser.jurusan_id).length;
            }
            document.getElementById('total-alat').textContent = totalAlat;

            // Update peminjaman aktif
            const peminjamanAktif = peminjaman.filter(p => p.status === 'Dipinjam').length;
            document.getElementById('total-peminjaman').textContent = peminjamanAktif;

            // Update alat terlambat
            const alatTerlambat = peminjaman.filter(p => p.status === 'Terlambat').length;
            document.getElementById('alat-terlambat').textContent = alatTerlambat;

            // Update alat tersedia
            let alatTersedia = 0;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                alatTersedia = alat
                    .filter(a => a.jurusan_id == currentUser.jurusan_id)
                    .reduce((sum, a) => sum + parseInt(a.jumlah_tersedia || 0), 0);
            } else {
                alatTersedia = alat.reduce((sum, a) => sum + parseInt(a.jumlah_tersedia || 0), 0);
            }
            document.getElementById('alat-tersedia').textContent = alatTersedia;

            // Update total kategori
            let totalKategori = kategori.length;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                totalKategori = kategori.filter(k => k.jurusan_id == currentUser.jurusan_id).length;
            }
            document.getElementById('total-kategori').textContent = totalKategori;
        }

        // ================== FUNGSI NAVIGASI ==================
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });
        }

        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });

            // Remove active class from all menu items
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected page
            const pageElement = document.getElementById(`${pageName}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
            }

            // Add active class to clicked menu item
            const activeLink = document.querySelector(`.nav-link[data-page="${pageName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Update page title
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');

            switch (pageName) {
                case 'dashboard':
                    pageTitle.textContent = 'Dashboard';
                    pageSubtitle.textContent = 'Selamat datang di sistem peminjaman alat';
                    updateDashboardStats();
                    loadDashboardData();
                    break;
                case 'alat':
                    pageTitle.textContent = 'Manajemen Alat';
                    pageSubtitle.textContent = 'Kelola data alat yang tersedia';
                    loadAlatTable();
                    break;
                case 'peminjaman':
                    pageTitle.textContent = 'Peminjaman';
                    pageSubtitle.textContent = 'Kelola data peminjaman alat';
                    loadPeminjamanTable();
                    break;
                case 'pengembalian':
                    pageTitle.textContent = 'Pengembalian';
                    pageSubtitle.textContent = 'Proses pengembalian alat';
                    loadPengembalianTable();
                    break;
                case 'riwayat':
                    pageTitle.textContent = 'Riwayat';
                    pageSubtitle.textContent = 'Riwayat peminjaman alat';
                    loadRiwayatTable();
                    break;
                case 'kategori':
                    pageTitle.textContent = 'Kategori Alat';
                    pageSubtitle.textContent = 'Kelola kategori alat per jurusan';
                    loadKategoriTable();
                    break;
                case 'jurusan':
                    pageTitle.textContent = 'Jurusan';
                    pageSubtitle.textContent = 'Kelola data jurusan';
                    loadJurusanTable();
                    break;
                case 'users':
                    pageTitle.textContent = 'Manajemen Pengguna';
                    pageSubtitle.textContent = 'Kelola data pengguna sistem';
                    loadUsersTable();
                    break;
                case 'settings':
                    pageTitle.textContent = 'Pengaturan';
                    pageSubtitle.textContent = 'Kelola pengaturan sistem';
                    loadSettingsPage();
                    break;
            }
        }

        // ================== FUNGSI MOBILE ==================
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebarClose = document.getElementById('sidebar-close');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function () {
                    sidebar.classList.remove('hidden');
                    sidebarOverlay.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }

            if (sidebarClose) {
                sidebarClose.addEventListener('click', function () {
                    sidebar.classList.add('hidden');
                    sidebarOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function () {
                    sidebar.classList.add('hidden');
                    sidebarOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }

            // Close sidebar ketika klik menu item di mobile
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function () {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.add('hidden');
                        sidebarOverlay.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            });
        }

        function checkMobileView() {
            const isMobile = window.innerWidth <= 768;
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (isMobile) {
                // Di mobile, sidebar hidden by default
                if (!sidebar.classList.contains('hidden')) {
                    sidebar.classList.add('hidden');
                }
                if (!mainContent.classList.contains('expanded')) {
                    mainContent.classList.add('expanded');
                }
                sidebarOverlay.style.display = 'none';

                // Load mobile table views
                loadMobileTables();
            } else {
                // Di desktop, sidebar visible
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('expanded');
                sidebarOverlay.style.display = 'none';
                document.body.style.overflow = '';

                // Show desktop tables, hide mobile cards
                document.querySelectorAll('.table-responsive').forEach(table => {
                    table.style.display = 'block';
                });
                document.querySelectorAll('.mobile-table-card').forEach(card => {
                    card.style.display = 'none';
                });
            }
        }

        function loadMobileTables() {
            // Load recent peminjaman mobile view
            loadRecentPeminjamanMobile();

            // Load alat mobile view
            loadAlatTableMobile();

            // Load peminjaman mobile view
            loadPeminjamanTableMobile();

            // Load pengembalian mobile view
            loadPengembalianTableMobile();

            // Load riwayat mobile view
            loadRiwayatTableMobile();

            // Load kategori mobile view
            loadKategoriTableMobile();

            // Load jurusan mobile view
            loadJurusanTableMobile();

            // Load users mobile view
            loadUsersTableMobile();
        }

        function loadRecentPeminjamanMobile() {
            const container = document.getElementById('recent-peminjaman-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Get recent 5 peminjaman
            const recent = [...peminjaman]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data</div>';
                return;
            }

            recent.forEach(p => {
                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})" style="flex: 1;">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" style="flex: 1;" title="Cetak Thermal">
                            <i class="fas fa-print"></i> Cetak
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No. Peminjaman</span>
                        <span class="mobile-table-value">${p.nomor_peminjaman}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Peminjam</span>
                        <span class="mobile-table-value">${p.nama_peminjam}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Pinjam</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_pinjam)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Estimasi Kembali</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_kembali_estimasi)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Status</span>
                        <span class="mobile-table-value"><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadAlatTableMobile() {
            const container = document.getElementById('alat-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Filter alat by user's jurusan if not superuser
            let filteredAlat = alat;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredAlat = alat.filter(a => a.jurusan_id == currentUser.jurusan_id);
            }

            if (filteredAlat.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data alat</div>';
                return;
            }

            filteredAlat.forEach(a => {
                const kategoriData = kategori.find(k => k.id == a.kategori_id);
                const kategoriNama = kategoriData ? kategoriData.nama : '-';

                const jurusanData = jurusan.find(j => j.id == a.jurusan_id);
                const jurusanNama = jurusanData ? jurusanData.nama : '-';

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="showAlatModal(${a.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlat(${a.id})" ${a.jumlah_tersedia < a.jumlah_total ? 'disabled' : ''} style="flex: 1;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kode Seri</span>
                        <span class="mobile-table-value">${a.kode_seri}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Alat</span>
                        <span class="mobile-table-value">${a.nama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kategori</span>
                        <span class="mobile-table-value">${kategoriNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jurusan</span>
                        <span class="mobile-table-value">${jurusanNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jumlah</span>
                        <span class="mobile-table-value">${a.jumlah_tersedia}/${a.jumlah_total}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kondisi</span>
                        <span class="mobile-table-value"><span class="badge ${getKondisiBadgeClass(a.kondisi)}">${a.kondisi}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadPeminjamanTableMobile() {
            const container = document.getElementById('peminjaman-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Filter peminjaman berdasarkan user role
            let filteredPeminjaman = peminjaman.filter(p => p.status === 'Dipinjam');
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredPeminjaman = filteredPeminjaman.filter(p => p.jurusan_id == currentUser.jurusan_id);
            }

            if (filteredPeminjaman.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data peminjaman</div>';
                return;
            }

            filteredPeminjaman.forEach(p => {
                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})" style="flex: 1;">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" style="flex: 1;">
                            <i class="fas fa-print"></i> Cetak
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No. Peminjaman</span>
                        <span class="mobile-table-value">${p.nomor_peminjaman}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Peminjam</span>
                        <span class="mobile-table-value">${p.nama_peminjam}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kelas</span>
                        <span class="mobile-table-value">${p.kelas_unit}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Pinjam</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_pinjam)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Kembali</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_kembali_estimasi)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Status</span>
                        <span class="mobile-table-value"><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadPengembalianTableMobile() {
            const container = document.getElementById('pengembalian-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Filter peminjaman yang aktif
            let filteredPeminjaman = peminjaman.filter(p => p.status === 'Dipinjam');
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredPeminjaman = filteredPeminjaman.filter(p => p.jurusan_id == currentUser.jurusan_id);
            }

            if (filteredPeminjaman.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada peminjaman aktif</div>';
                return;
            }

            filteredPeminjaman.forEach(p => {
                // Get alat names
                let alatNames = [];
                if (p.items && p.items.length > 0) {
                    p.items.forEach(item => {
                        const alatData = alat.find(a => a.id == item.id);
                        if (alatData) {
                            alatNames.push(`${alatData.nama} x${item.jumlah}`);
                        }
                    });
                }

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-success" onclick="processPengembalian(${p.id})" style="flex: 1;">
                            <i class="fas fa-check"></i> Proses
                        </button>
                        <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})" style="flex: 1;">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No. Peminjaman</span>
                        <span class="mobile-table-value">${p.nomor_peminjaman}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Peminjam</span>
                        <span class="mobile-table-value">${p.nama_peminjam}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Alat</span>
                        <span class="mobile-table-value">${alatNames.join(', ') || '-'}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Pinjam</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_pinjam)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Status</span>
                        <span class="mobile-table-value"><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadRiwayatTableMobile() {
            const container = document.getElementById('riwayat-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Filter riwayat berdasarkan user role
            let filteredRiwayat = peminjaman;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredRiwayat = peminjaman.filter(p => p.jurusan_id == currentUser.jurusan_id);
            }

            if (filteredRiwayat.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada riwayat</div>';
                return;
            }

            filteredRiwayat.forEach(p => {
                // Get alat names
                let alatNames = [];
                if (p.items && p.items.length > 0) {
                    p.items.forEach(item => {
                        const alatData = alat.find(a => a.id == item.id);
                        if (alatData) {
                            alatNames.push(`${alatData.nama} x${item.jumlah}`);
                        }
                    });
                }

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})" style="flex: 1;">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" style="flex: 1;">
                            <i class="fas fa-print"></i> Cetak
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No. Peminjaman</span>
                        <span class="mobile-table-value">${p.nomor_peminjaman}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Peminjam</span>
                        <span class="mobile-table-value">${p.nama_peminjam}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kelas</span>
                        <span class="mobile-table-value">${p.kelas_unit}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Alat</span>
                        <span class="mobile-table-value">${alatNames.join(', ') || '-'}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Pinjam</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_pinjam)}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Tanggal Kembali</span>
                        <span class="mobile-table-value">${formatDate(p.tanggal_kembali_aktual) || '-'}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Status</span>
                        <span class="mobile-table-value"><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadKategoriTableMobile() {
            const container = document.getElementById('kategori-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            // Filter kategori berdasarkan user role
            let filteredKategori = kategori;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredKategori = kategori.filter(k => k.jurusan_id == currentUser.jurusan_id);
            }

            if (filteredKategori.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data kategori</div>';
                return;
            }

            filteredKategori.forEach((k, index) => {
                // Count alat in this kategori
                const alatCount = alat.filter(a => a.kategori_id == k.id).length;

                // Get jurusan name
                const jurusanData = jurusan.find(j => j.id == k.jurusan_id);
                const jurusanNama = jurusanData ? jurusanData.nama : '-';

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="editKategori(${k.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKategori(${k.id})" ${alatCount > 0 ? 'disabled' : ''} style="flex: 1;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No</span>
                        <span class="mobile-table-value">${index + 1}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Kategori</span>
                        <span class="mobile-table-value">${k.nama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jurusan</span>
                        <span class="mobile-table-value">${jurusanNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jumlah Alat</span>
                        <span class="mobile-table-value">${alatCount}</span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadJurusanTableMobile() {
            const container = document.getElementById('jurusan-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            if (jurusan.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data jurusan</div>';
                return;
            }

            jurusan.forEach((j, index) => {
                // Count alat in this jurusan
                const alatCount = alat.filter(a => a.jurusan_id == j.id).length;

                // Count kategori in this jurusan
                const kategoriCount = kategori.filter(k => k.jurusan_id == j.id).length;

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="editJurusan(${j.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJurusan(${j.id})" ${alatCount > 0 || kategoriCount > 0 ? 'disabled' : ''} style="flex: 1;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">No</span>
                        <span class="mobile-table-value">${index + 1}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Jurusan</span>
                        <span class="mobile-table-value">${j.nama} (${j.kode})</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jumlah Alat</span>
                        <span class="mobile-table-value">${alatCount}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jumlah Kategori</span>
                        <span class="mobile-table-value">${kategoriCount}</span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        function loadUsersTableMobile() {
            const container = document.getElementById('users-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data user</div>';
                return;
            }

            users.forEach(u => {
                const jurusanData = jurusan.find(j => j.id == u.jurusan_id);
                const jurusanNama = jurusanData ? jurusanData.nama : '-';

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="editUser(${u.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})" ${u.id === 1 ? 'disabled' : ''} style="flex: 1;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Lengkap</span>
                        <span class="mobile-table-value">${u.full_name}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Username</span>
                        <span class="mobile-table-value">${u.username}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Role</span>
                        <span class="mobile-table-value">${u.role === 'superuser' ? 'Super User' : 'Guru'}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jurusan</span>
                        <span class="mobile-table-value">${jurusanNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Status</span>
                        <span class="mobile-table-value"><span class="badge badge-success">Aktif</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        // ================== FUNGSI MODAL ==================
        function setupModalButtons() {
            // Alat modal
            const tambahAlatBtn = document.getElementById('tambah-alat-btn');
            if (tambahAlatBtn) {
                tambahAlatBtn.addEventListener('click', function () {
                    showAlatModal();
                });
            }

            // Peminjaman modal
            const tambahPeminjamanBtn = document.getElementById('tambah-peminjaman-btn');
            if (tambahPeminjamanBtn) {
                tambahPeminjamanBtn.addEventListener('click', function () {
                    showPeminjamanModal();
                });
            }

            // Manual return button
            const inputManualBtn = document.getElementById('input-manual-btn');
            if (inputManualBtn) {
                inputManualBtn.addEventListener('click', function () {
                    showManualReturnModal();
                });
            }

            // Barcode scan button
            const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
            if (scanBarcodeBtn) {
                scanBarcodeBtn.addEventListener('click', function () {
                    // Untuk demo, kita akan simulasi scan barcode
                    showModal('camera-modal');
                });
            }

            // Kategori modal
            const tambahKategoriBtn = document.getElementById('tambah-kategori-btn');
            if (tambahKategoriBtn) {
                tambahKategoriBtn.addEventListener('click', function () {
                    showKategoriModal();
                });
            }

            // Jurusan modal
            const tambahJurusanBtn = document.getElementById('tambah-jurusan-btn');
            if (tambahJurusanBtn) {
                tambahJurusanBtn.addEventListener('click', function () {
                    showJurusanModal();
                });
            }

            // User modal
            const tambahUserBtn = document.getElementById('tambah-user-btn');
            if (tambahUserBtn) {
                tambahUserBtn.addEventListener('click', function () {
                    showUserModal();
                });
            }

            // Form submit handlers
            const formAlat = document.getElementById('form-alat');
            if (formAlat) {
                formAlat.addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveAlat();
                });
            }

            const formPeminjaman = document.getElementById('form-peminjaman');
            if (formPeminjaman) {
                formPeminjaman.addEventListener('submit', function (e) {
                    e.preventDefault();
                    savePeminjaman();
                });
            }

            const formManualReturn = document.getElementById('form-manual-return');
            if (formManualReturn) {
                formManualReturn.addEventListener('submit', function (e) {
                    e.preventDefault();
                    processManualReturn();
                });
            }

            const formKategori = document.getElementById('form-kategori');
            if (formKategori) {
                formKategori.addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveKategori();
                });
            }

            const formJurusan = document.getElementById('form-jurusan');
            if (formJurusan) {
                formJurusan.addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveJurusan();
                });
            }

            const formUser = document.getElementById('form-user');
            if (formUser) {
                formUser.addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveUser();
                });
            }
        }

        async function showAlatModal(id = null) {
            const modalTitle = document.getElementById('modal-alat-title');
            const form = document.getElementById('form-alat');

            if (id) {
                // Edit mode
                const alatData = alat.find(a => a.id == id);
                if (alatData) {
                    modalTitle.textContent = 'Edit Data Alat';
                    document.getElementById('alat-id').value = alatData.id;
                    document.getElementById('alat-kode-seri').value = alatData.kode_seri;
                    document.getElementById('alat-nama').value = alatData.nama;
                    document.getElementById('alat-kategori').value = alatData.kategori_id;
                    document.getElementById('alat-jurusan').value = alatData.jurusan_id;
                    document.getElementById('alat-jumlah-total').value = alatData.jumlah_total;
                    document.getElementById('alat-jumlah-tersedia').value = alatData.jumlah_tersedia;
                    document.getElementById('alat-kondisi').value = alatData.kondisi;
                    document.getElementById('alat-keterangan').value = alatData.keterangan || '';

                    // Show foto preview if exists
                    if (alatData.foto) {
                        document.getElementById('foto-preview').src = alatData.foto;
                        document.getElementById('foto-preview-container').style.display = 'block';
                    }
                }
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Alat Baru';
                form.reset();
                document.getElementById('alat-id').value = '';
                document.getElementById('foto-preview-container').style.display = 'none';
            }

            // Populate kategori dropdown
            const kategoriSelect = document.getElementById('alat-kategori');
            kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';

            // Filter kategori berdasarkan user role
            let filteredKategori = kategori;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredKategori = kategori.filter(k => k.jurusan_id == currentUser.jurusan_id);
            }

            filteredKategori.forEach(k => {
                const option = document.createElement('option');
                option.value = k.id;
                option.textContent = k.nama;
                kategoriSelect.appendChild(option);
            });

            // Populate jurusan dropdown
            const jurusanSelect = document.getElementById('alat-jurusan');
            jurusanSelect.innerHTML = '<option value="">Pilih Jurusan</option>';

            // Filter jurusan berdasarkan user role
            let filteredJurusan = jurusan;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredJurusan = jurusan.filter(j => j.id == currentUser.jurusan_id);
            }

            filteredJurusan.forEach(j => {
                const option = document.createElement('option');
                option.value = j.id;
                option.textContent = j.nama;
                jurusanSelect.appendChild(option);
            });

            showModal('alat-modal');
        }

        function previewFotoAlat(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Ukuran file terlalu besar! Maksimal 2MB.');
                return;
            }

            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert('Format file tidak didukung! Gunakan JPG atau PNG.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('foto-preview');
                const container = document.getElementById('foto-preview-container');

                preview.src = e.target.result;
                container.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }

        function showPeminjamanModal() {
            // Reset daftar alat yang dipinjam
            alatDipinjam = [];
            document.getElementById('daftar-alat-pinjam').innerHTML = '';
            document.getElementById('total-alat-dipinjam').style.display = 'none';

            // Populate jurusan dropdown
            const jurusanSelect = document.getElementById('peminjaman-jurusan');
            jurusanSelect.innerHTML = '<option value="">Pilih Jurusan...</option>';

            let filteredJurusan = jurusan;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredJurusan = jurusan.filter(j => j.id == currentUser.jurusan_id);
            }

            filteredJurusan.forEach(j => {
                const option = document.createElement('option');
                option.value = j.id;
                option.textContent = j.nama;
                jurusanSelect.appendChild(option);
            });

            // Set tanggal kembali default
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('peminjaman-tanggal-kembali').value = nextWeek.toISOString().split('T')[0];

            showModal('peminjaman-modal');
        }

        function updateAlatDropdown() {
            const jurusanId = parseInt(document.getElementById('peminjaman-jurusan').value);
            const alatSelect = document.getElementById('alat-pilihan');
            alatSelect.innerHTML = '<option value="">Pilih Alat...</option>';

            if (!jurusanId) return;

            // Filter alat berdasarkan jurusan dan ketersediaan
            let filteredAlat = alat.filter(a => a.jurusan_id == jurusanId && a.jumlah_tersedia > 0);

            filteredAlat.forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = `${a.kode_seri} - ${a.nama} (Tersedia: ${a.jumlah_tersedia})`;
                alatSelect.appendChild(option);
            });
        }

        function tambahAlatKeDaftarPinjam() {
            const alatSelect = document.getElementById('alat-pilihan');
            const alatId = parseInt(alatSelect.value);

            if (!alatId) return;

            // Cek apakah alat sudah ada di daftar
            const sudahAda = alatDipinjam.find(item => item.id === alatId);
            if (sudahAda) {
                alert('Alat ini sudah ada di daftar peminjaman!');
                alatSelect.value = '';
                return;
            }

            // Cari data alat
            const alatData = alat.find(a => a.id == alatId);
            if (!alatData) return;

            // Tambah ke daftar
            alatDipinjam.push({
                id: alatData.id,
                kode_seri: alatData.kode_seri,
                nama: alatData.nama,
                jumlah_tersedia: parseInt(alatData.jumlah_tersedia),
                jumlah_pinjam: 1
            });

            // Update tampilan
            updateDaftarAlatPinjam();

            // Reset dropdown
            alatSelect.value = '';
        }

        function updateDaftarAlatPinjam() {
            const container = document.getElementById('daftar-alat-pinjam');
            const totalElement = document.getElementById('total-jumlah-alat');

            container.innerHTML = '';

            if (alatDipinjam.length === 0) {
                document.getElementById('total-alat-dipinjam').style.display = 'none';
                return;
            }

            let totalJumlah = 0;

            alatDipinjam.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'alat-pinjam-item';

                div.innerHTML = `
                    <div class="alat-info">
                        <div class="alat-name">${item.kode_seri} - ${item.nama}</div>
                        <div class="alat-stock">Tersedia: ${item.jumlah_tersedia}</div>
                    </div>
                    <div>
                        <input type="number" 
                               class="form-control alat-jumlah-input" 
                               value="${item.jumlah_pinjam}" 
                               min="1" 
                               max="${item.jumlah_tersedia}"
                               onchange="updateJumlahAlat(${index}, this.value)">
                    </div>
                    <button type="button" class="remove-alat-btn" onclick="hapusAlatDariDaftar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(div);
                totalJumlah += item.jumlah_pinjam;
            });

            totalElement.textContent = totalJumlah;
            document.getElementById('total-alat-dipinjam').style.display = 'block';
        }

        function updateJumlahAlat(index, jumlah) {
            const jumlahNum = parseInt(jumlah);
            const alatItem = alatDipinjam[index];

            if (jumlahNum < 1) {
                alatItem.jumlah_pinjam = 1;
            } else if (jumlahNum > alatItem.jumlah_tersedia) {
                alatItem.jumlah_pinjam = alatItem.jumlah_tersedia;
                alert(`Jumlah tidak boleh melebihi stok tersedia (${alatItem.jumlah_tersedia})`);
            } else {
                alatItem.jumlah_pinjam = jumlahNum;
            }

            updateDaftarAlatPinjam();
        }

        function hapusAlatDariDaftar(index) {
            alatDipinjam.splice(index, 1);
            updateDaftarAlatPinjam();
        }

        // ================== FUNGSI LOAD DATA ==================
        function loadDashboardData() {
            // Load recent peminjaman desktop table
            const tbody = document.querySelector('#recent-peminjaman tbody');
            if (tbody) {
                tbody.innerHTML = '';

                const recent = [...peminjaman]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);

                recent.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.nomor_peminjaman}</td>
                        <td>${p.nama_peminjam}</td>
                        <td>${formatDate(p.tanggal_pinjam)}</td>
                        <td>${formatDate(p.tanggal_kembali_estimasi)}</td>
                        <td><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" title="Cetak Thermal">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Load mobile view if on mobile
            if (window.innerWidth <= 768) {
                loadRecentPeminjamanMobile();
            }
        }

        function loadAlatTable() {
            // Filter alat by user's jurusan if not superuser
            let filteredAlat = alat;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredAlat = alat.filter(a => a.jurusan_id == currentUser.jurusan_id);
            }

            // Update count
            document.getElementById('alat-count').textContent = filteredAlat.length;

            // Load desktop table
            const tbody = document.querySelector('#alat-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                filteredAlat.forEach(a => {
                    const kategoriData = kategori.find(k => k.id == a.kategori_id);
                    const kategoriNama = kategoriData ? kategoriData.nama : '-';

                    const jurusanData = jurusan.find(j => j.id == a.jurusan_id);
                    const jurusanNama = jurusanData ? jurusanData.nama : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${a.foto ?
                            `<img src="${a.foto}" class="alat-thumbnail" alt="${a.nama}">` :
                            `<div class="alat-thumbnail" style="background: var(--gradient-primary); color: white; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-tools"></i>
                                </div>`
                        }
                        </td>
                        <td>${a.kode_seri}</td>
                        <td>${a.nama}</td>
                        <td>${kategoriNama}</td>
                        <td>${jurusanNama}</td>
                        <td>${a.jumlah_total}</td>
                        <td>${a.jumlah_tersedia}</td>
                        <td><span class="badge ${getKondisiBadgeClass(a.kondisi)}">${a.kondisi}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="showAlatModal(${a.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAlat(${a.id})" ${a.jumlah_tersedia < a.jumlah_total ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Populate kategori filter
            const filterKategori = document.getElementById('filter-kategori');
            if (filterKategori) {
                filterKategori.innerHTML = '<option value="all">Semua Kategori</option>';

                // Filter kategori berdasarkan user role
                let filteredKategori = kategori;
                if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                    filteredKategori = kategori.filter(k => k.jurusan_id == currentUser.jurusan_id);
                }

                filteredKategori.forEach(k => {
                    const option = document.createElement('option');
                    option.value = k.id;
                    option.textContent = k.nama;
                    filterKategori.appendChild(option);
                });
            }

            // Populate jurusan filter
            const filterJurusan = document.getElementById('filter-jurusan');
            if (filterJurusan) {
                filterJurusan.innerHTML = '<option value="all">Semua Jurusan</option>';

                // Filter jurusan berdasarkan user role
                let filteredJurusan = jurusan;
                if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                    filteredJurusan = jurusan.filter(j => j.id == currentUser.jurusan_id);
                }

                filteredJurusan.forEach(j => {
                    const option = document.createElement('option');
                    option.value = j.id;
                    option.textContent = j.nama;
                    filterJurusan.appendChild(option);
                });
            }

            // Load mobile view if on mobile
            if (window.innerWidth <= 768) {
                loadAlatTableMobile();
            }
        }

        function loadPeminjamanTable() {
            const tbody = document.querySelector('#peminjaman-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                peminjaman.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.nomor_peminjaman}</td>
                        <td>${p.nama_peminjam}</td>
                        <td>${p.kelas_unit}</td>
                        <td>${formatDate(p.tanggal_pinjam)}</td>
                        <td>${formatDate(p.tanggal_kembali_aktual) || '-'}</td>
                        <td><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" title="Cetak Thermal">
                                    <i class="fas fa-print"></i>
                                </button>
                                ${p.status === 'Dipinjam' ? `
                                    <button class="btn btn-sm btn-success" onclick="processPengembalian(${p.id})">
                                        <i class="fas fa-check"></i> Kembalikan
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function loadPengembalianTable() {
            const tbody = document.querySelector('#pengembalian-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                // Filter peminjaman yang aktif
                const activeLoans = peminjaman.filter(p => p.status === 'Dipinjam');

                // Filter berdasarkan jurusan user jika bukan superuser
                let filteredLoans = activeLoans;
                if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                    filteredLoans = activeLoans.filter(p => {
                        return p.jurusan_id == currentUser.jurusan_id;
                    });
                }

                filteredLoans.forEach(p => {
                    // Get alat names
                    let alatNames = [];
                    if (p.items && p.items.length > 0) {
                        p.items.forEach(item => {
                            const alatData = alat.find(a => a.id == item.id);
                            if (alatData) {
                                alatNames.push(`${alatData.nama} x${item.jumlah}`);
                            }
                        });
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.nomor_peminjaman}</td>
                        <td>${p.nama_peminjam}</td>
                        <td>${alatNames.join(', ') || '-'}</td>
                        <td>${formatDate(p.tanggal_pinjam)}</td>
                        <td><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success" onclick="showManualReturnModalWithPeminjaman(${p.id})">
                                    <i class="fas fa-check"></i> Proses Pengembalian
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function showManualReturnModalWithPeminjaman(peminjamanId) {
            const selectElement = document.getElementById('select-peminjaman');
            selectElement.value = peminjamanId;
            showModal('manual-return-modal');
        }

        function loadRiwayatTable() {
            const tbody = document.querySelector('#riwayat-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                // Filter riwayat yang sudah dikembalikan
                const riwayat = peminjaman.filter(p => p.status === 'Dikembalikan' || p.status === 'Terlambat');

                // Filter berdasarkan jurusan user jika bukan superuser
                let filteredRiwayat = riwayat;
                if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                    filteredRiwayat = riwayat.filter(p => {
                        return p.jurusan_id == currentUser.jurusan_id;
                    });
                }

                filteredRiwayat.forEach(p => {
                    // Get alat names
                    let alatNames = [];
                    if (p.items && p.items.length > 0) {
                        p.items.forEach(item => {
                            const alatData = alat.find(a => a.id == item.id);
                            if (alatData) {
                                alatNames.push(`${alatData.nama} x${item.jumlah}`);
                            }
                        });
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.nomor_peminjaman}</td>
                        <td>${p.nama_peminjam}</td>
                        <td>${p.kelas_unit}</td>
                        <td>${alatNames.join(', ') || '-'}</td>
                        <td>${formatDate(p.tanggal_pinjam)}</td>
                        <td>${formatDate(p.tanggal_kembali_aktual) || '-'}</td>
                        <td><span class="badge ${getStatusBadgeClass(p.status)}">${p.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="showDetailPeminjamanWithBarcode(${p.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="printThermalSingle(${p.id})" title="Cetak Thermal">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function loadKategoriTable() {
            const tbody = document.querySelector('#kategori-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                // Filter kategori berdasarkan user role
                let filteredKategori = kategori;
                if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                    filteredKategori = kategori.filter(k => k.jurusan_id == currentUser.jurusan_id);
                }

                filteredKategori.forEach((k, index) => {
                    // Count alat in this kategori
                    const alatCount = alat.filter(a => a.kategori_id == k.id).length;

                    // Get jurusan name
                    const jurusanData = jurusan.find(j => j.id == k.jurusan_id);
                    const jurusanNama = jurusanData ? jurusanData.nama : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${k.nama}</td>
                        <td>${jurusanNama}</td>
                        <td>-</td>
                        <td>${alatCount}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="editKategori(${k.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteKategori(${k.id})" ${alatCount > 0 ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function loadJurusanTable() {
            const tbody = document.querySelector('#jurusan-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                jurusan.forEach((j, index) => {
                    // Count alat in this jurusan
                    const alatCount = alat.filter(a => a.jurusan_id == j.id).length;

                    // Count kategori in this jurusan
                    const kategoriCount = kategori.filter(k => k.jurusan_id == j.id).length;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${j.nama} (${j.kode})</td>
                        <td>${alatCount}</td>
                        <td>${kategoriCount}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="editJurusan(${j.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteJurusan(${j.id})" ${alatCount > 0 || kategoriCount > 0 ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function loadUsersTable() {
            const tbody = document.querySelector('#users-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                users.forEach(u => {
                    const jurusanData = jurusan.find(j => j.id == u.jurusan_id);
                    const jurusanNama = jurusanData ? jurusanData.nama : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${u.full_name}</td>
                        <td>${u.username}</td>
                        <td>${u.role === 'superuser' ? 'Super User' : 'Guru'}</td>
                        <td>${jurusanNama}</td>
                        <td><span class="badge badge-success">Aktif</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="editUser(${u.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})" ${u.id === 1 ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row); // FIX: Added missing appendChild
                });
            }
        }

        // ================== FUNGSI LOGIN ==================
        // Setup login form event listener
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                // Assuming there's a login function to call here
                // For example: await login(username, password);
                // This part of the login logic is not provided in the snippet.
                // The snippet only shows the event listener setup.
            });
        }

        // ================== FUNGSI CRUD ==================
        async function saveAlat() {
            const id = document.getElementById('alat-id').value;
            const kodeSeri = document.getElementById('alat-kode-seri').value;
            const nama = document.getElementById('alat-nama').value;
            const kategoriId = parseInt(document.getElementById('alat-kategori').value);
            const jurusanId = parseInt(document.getElementById('alat-jurusan').value);
            const jumlahTotal = parseInt(document.getElementById('alat-jumlah-total').value);
            const jumlahTersedia = parseInt(document.getElementById('alat-jumlah-tersedia').value);
            const kondisi = document.getElementById('alat-kondisi').value;
            const keterangan = document.getElementById('alat-keterangan').value;
            const fotoFile = document.getElementById('alat-foto').files[0];

            if (jumlahTersedia > jumlahTotal) {
                alert('Jumlah tersedia tidak boleh lebih besar dari jumlah total!');
                return;
            }

            let fotoUrl = '';

            // Upload foto jika ada
            if (fotoFile) {
                try {
                    const uploadResult = await uploadFoto(fotoFile);
                    if (uploadResult.success) {
                        fotoUrl = uploadResult.downloadUrl;
                    } else {
                        alert('Gagal mengunggah foto: ' + uploadResult.message);
                        return;
                    }
                } catch (error) {
                    alert('Gagal mengunggah foto: ' + error.message);
                    return;
                }
            } else {
                // Jika edit mode dan tidak upload foto baru, gunakan foto lama
                if (id) {
                    const alatData = alat.find(a => a.id == id);
                    if (alatData && alatData.foto) {
                        fotoUrl = alatData.foto;
                    }
                }
            }

            const alatData = {
                kode_seri: kodeSeri,
                nama: nama,
                kategori_id: kategoriId,
                jumlah_total: jumlahTotal,
                jumlah_tersedia: jumlahTersedia,
                kondisi: kondisi,
                keterangan: keterangan,
                jurusan_id: jurusanId,
                foto: fotoUrl
            };

            // OPTIMISTIC UI: Close modal immediately
            closeModal('alat-modal');

            // Show initial toast
            showToast('Menyimpan...', 'Data alat sedang disimpan', 'info', 2000);

            // Save in background (non-blocking)
            if (id) {
                alatData.id = parseInt(id);
                saveDataToSpreadsheet('updateAlat', alatData).then(result => {
                    if (result.success) {
                        loadAlatTable();
                        updateDashboardStats();
                    }
                });
            } else {
                saveDataToSpreadsheet('saveAlat', alatData).then(result => {
                    if (result.success) {
                        loadAlatTable();
                        updateDashboardStats();
                    }
                });
            }
        }

        async function deleteAlat(id) {
            if (confirm('Apakah Anda yakin ingin menghapus alat ini?')) {
                const alatData = alat.find(a => a.id == id);
                if (alatData && alatData.jumlah_tersedia < alatData.jumlah_total) {
                    alert('Alat tidak dapat dihapus karena masih ada yang dipinjam!');
                    return;
                }

                const result = await saveDataToSpreadsheet('deleteAlat', { id: id });
                if (result.success) {
                    alert('Alat berhasil dihapus!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadAlatTable();
                    updateDashboardStats();
                }
            }
        }

        function generateNomorPeminjaman(jurusanId) {
            // Cari jurusan berdasarkan ID
            const jurusanData = jurusan.find(j => j.id == jurusanId);
            const kodeJurusan = jurusanData ? jurusanData.kode : 'UM';

            // Cari nomor urut terakhir untuk jurusan ini
            const tahun = new Date().getFullYear();
            const peminjamanJurusan = peminjaman.filter(p => {
                // Ekstrak kode jurusan dari nomor peminjaman
                const parts = p.nomor_peminjaman.split('-');
                return parts[0] === kodeJurusan && parts[1] === tahun.toString();
            });

            const nomorUrut = peminjamanJurusan.length > 0 ?
                Math.max(...peminjamanJurusan.map(p => {
                    const parts = p.nomor_peminjaman.split('-');
                    return parseInt(parts[2]) || 0;
                })) + 1 : 1;

            return `${kodeJurusan}-${tahun}-${String(nomorUrut).padStart(3, '0')}`;
        }

        async function savePeminjaman() {
            const namaPeminjam = document.getElementById('peminjam-nama').value;
            const kelas = document.getElementById('peminjam-kelas').value;
            const nomorHp = document.getElementById('peminjam-nomor-hp').value;
            const jurusanId = parseInt(document.getElementById('peminjaman-jurusan').value);
            const tanggalKembali = document.getElementById('peminjaman-tanggal-kembali').value;
            const keperluan = document.getElementById('peminjaman-keperluan').value;

            // Validasi
            if (!jurusanId) {
                alert('Pilih jurusan terlebih dahulu!');
                return;
            }

            if (alatDipinjam.length === 0) {
                alert('Pilih minimal satu alat!');
                return;
            }

            // Check alat availability
            for (const item of alatDipinjam) {
                const alatData = alat.find(a => a.id == item.id);
                if (!alatData || item.jumlah_pinjam > alatData.jumlah_tersedia) {
                    alert(`Jumlah alat ${item.nama} tidak tersedia!`);
                    return;
                }
            }

            const today = new Date().toISOString().split('T')[0];
            const nomorPeminjaman = generateNomorPeminjaman(jurusanId);

            const peminjamanData = {
                nomor_peminjaman: nomorPeminjaman,
                nama_peminjam: namaPeminjam,
                nomor_hp: nomorHp,
                kelas_unit: kelas,
                tanggal_pinjam: today,
                tanggal_kembali_estimasi: tanggalKembali,
                items: alatDipinjam.map(item => ({
                    id: item.id,
                    jumlah: item.jumlah_pinjam
                })),
                jurusan_id: jurusanId,
                created_by: currentUser.id
            };

            // OPTIMISTIC UI: Close modal immediately
            alatDipinjam = [];
            closeModal('peminjaman-modal');
            showToast('Menyimpan...', 'Peminjaman sedang diproses', 'info', 2000);

            // Save in background
            saveDataToSpreadsheet('savePeminjaman', peminjamanData).then(result => {
                if (result.success) {
                    loadPeminjamanTable();
                    loadRiwayatTable();
                    updateDashboardStats();

                    // Tampilkan detail dengan barcode
                    const newPeminjaman = peminjaman.find(p => p.nomor_peminjaman === nomorPeminjaman);
                    if (newPeminjaman) {
                        showDetailPeminjamanWithBarcode(newPeminjaman.id);
                    }
                }
            });
        }

        function showManualReturnModal() {
            const selectElement = document.getElementById('select-peminjaman');
            selectElement.innerHTML = '<option value="">Pilih peminjaman...</option>';

            // Filter hanya peminjaman yang aktif
            const activeLoans = peminjaman.filter(p => p.status === 'Dipinjam');

            // Filter berdasarkan jurusan user jika bukan superuser
            let filteredLoans = activeLoans;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredLoans = activeLoans.filter(p => {
                    return p.jurusan_id == currentUser.jurusan_id;
                });
            }

            filteredLoans.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nomor_peminjaman} - ${p.nama_peminjam}`;
                selectElement.appendChild(option);
            });

            showModal('manual-return-modal');
        }

        async function processManualReturn() {
            const peminjamanId = parseInt(document.getElementById('select-peminjaman').value);
            const kondisi = document.getElementById('kondisi-kembali').value;
            const keterangan = document.getElementById('keterangan-kembali').value;

            if (!peminjamanId) {
                alert('Pilih peminjaman terlebih dahulu!');
                return;
            }

            const result = await saveDataToSpreadsheet('processPengembalian', {
                id: peminjamanId,
                kondisi: kondisi,
                keterangan: keterangan
            });

            if (result.success) {
                closeModal('manual-return-modal');
                alert('Pengembalian berhasil diproses!');
            }
        }

        async function processPengembalian(peminjamanId) {
            if (confirm('Proses pengembalian untuk peminjaman ini?')) {
                const result = await saveDataToSpreadsheet('processPengembalian', { id: peminjamanId });
                if (result.success) {
                    alert('Pengembalian berhasil diproses!');
                }
            }
        }

        // ================== FUNGSI KATEGORI ==================
        function showKategoriModal(id = null) {
            const modalTitle = document.getElementById('modal-kategori-title');
            const form = document.getElementById('form-kategori');

            if (id) {
                // Edit mode
                const kategoriData = kategori.find(k => k.id == id);
                if (kategoriData) {
                    modalTitle.textContent = 'Edit Kategori';
                    document.getElementById('kategori-id').value = kategoriData.id;
                    document.getElementById('kategori-nama').value = kategoriData.nama;
                    document.getElementById('kategori-jurusan').value = kategoriData.jurusan_id;
                }
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Kategori Baru';
                form.reset();
                document.getElementById('kategori-id').value = '';
            }

            // Populate jurusan dropdown
            const jurusanSelect = document.getElementById('kategori-jurusan');
            jurusanSelect.innerHTML = '<option value="">Pilih Jurusan</option>';

            // Filter jurusan berdasarkan user role
            let filteredJurusan = jurusan;
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredJurusan = jurusan.filter(j => j.id == currentUser.jurusan_id);
            }

            filteredJurusan.forEach(j => {
                const option = document.createElement('option');
                option.value = j.id;
                option.textContent = j.nama;
                jurusanSelect.appendChild(option);
            });

            showModal('kategori-modal');
        }

        async function saveKategori() {
            const id = document.getElementById('kategori-id').value;
            const nama = document.getElementById('kategori-nama').value;
            const jurusanId = parseInt(document.getElementById('kategori-jurusan').value);
            const deskripsi = document.getElementById('kategori-deskripsi').value;

            if (!nama || !jurusanId) {
                alert('Nama kategori dan jurusan harus diisi!');
                return;
            }

            const kategoriData = {
                nama: nama,
                jurusan_id: jurusanId
            };

            if (id) {
                kategoriData.id = parseInt(id);
                const result = await saveDataToSpreadsheet('saveKategori', kategoriData);
                if (result.success) {
                    alert('Data kategori berhasil diperbarui!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadKategoriTable();
                }
            } else {
                const result = await saveDataToSpreadsheet('saveKategori', kategoriData);
                if (result.success) {
                    alert('Data kategori berhasil disimpan!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadKategoriTable();
                }
            }

            closeModal('kategori-modal');
        }

        function editKategori(id) {
            showKategoriModal(id);
        }

        async function deleteKategori(id) {
            if (confirm('Apakah Anda yakin ingin menghapus kategori ini?')) {
                // Cek apakah ada alat yang menggunakan kategori ini
                const alatCount = alat.filter(a => a.kategori_id == id).length;
                if (alatCount > 0) {
                    alert('Kategori tidak dapat dihapus karena masih digunakan oleh ' + alatCount + ' alat!');
                    return;
                }

                const result = await saveDataToSpreadsheet('deleteKategori', { id: id });
                if (result.success) {
                    alert('Kategori berhasil dihapus!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadKategoriTable();
                }
            }
        }

        // ================== FUNGSI JURUSAN ==================
        function showJurusanModal(id = null) {
            const modalTitle = document.getElementById('modal-jurusan-title');
            const form = document.getElementById('form-jurusan');

            if (id) {
                // Edit mode
                const jurusanData = jurusan.find(j => j.id == id);
                if (jurusanData) {
                    modalTitle.textContent = 'Edit Jurusan';
                    document.getElementById('jurusan-id').value = jurusanData.id;
                    document.getElementById('jurusan-nama').value = jurusanData.nama;
                    document.getElementById('jurusan-kode').value = jurusanData.kode;
                    document.getElementById('jurusan-deskripsi').value = jurusanData.deskripsi || '';
                }
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Jurusan Baru';
                form.reset();
                document.getElementById('jurusan-id').value = '';
            }

            showModal('jurusan-modal');
        }

        async function saveJurusan() {
            const id = document.getElementById('jurusan-id').value;
            const nama = document.getElementById('jurusan-nama').value;
            const kode = document.getElementById('jurusan-kode').value;
            const deskripsi = document.getElementById('jurusan-deskripsi').value;

            if (!nama || !kode) {
                alert('Nama jurusan dan kode harus diisi!');
                return;
            }

            // Cek duplikasi kode
            const existingJurusan = jurusan.find(j => j.kode === kode && j.id != parseInt(id || 0));
            if (existingJurusan) {
                alert('Kode jurusan sudah digunakan!');
                return;
            }

            const jurusanData = {
                nama: nama,
                kode: kode,
                deskripsi: deskripsi
            };

            if (id) {
                jurusanData.id = parseInt(id);
                const result = await saveDataToSpreadsheet('saveJurusan', jurusanData);
                if (result.success) {
                    alert('Data jurusan berhasil diperbarui!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadJurusanTable();
                }
            } else {
                const result = await saveDataToSpreadsheet('saveJurusan', jurusanData);
                if (result.success) {
                    alert('Data jurusan berhasil disimpan!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadJurusanTable();
                }
            }

            closeModal('jurusan-modal');
        }

        function editJurusan(id) {
            showJurusanModal(id);
        }

        async function deleteJurusan(id) {
            if (confirm('Apakah Anda yakin ingin menghapus jurusan ini?')) {
                // Cek apakah ada alat yang menggunakan jurusan ini
                const alatCount = alat.filter(a => a.jurusan_id == id).length;
                const kategoriCount = kategori.filter(k => k.jurusan_id == id).length;
                const userCount = users.filter(u => u.jurusan_id == id).length;

                if (alatCount > 0 || kategoriCount > 0 || userCount > 0) {
                    let message = 'Jurusan tidak dapat dihapus karena masih digunakan oleh:';
                    if (alatCount > 0) message += `\n- ${alatCount} alat`;
                    if (kategoriCount > 0) message += `\n- ${kategoriCount} kategori`;
                    if (userCount > 0) message += `\n- ${userCount} pengguna`;
                    alert(message);
                    return;
                }

                const result = await saveDataToSpreadsheet('deleteJurusan', { id: id });
                if (result.success) {
                    alert('Jurusan berhasil dihapus!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadJurusanTable();
                }
            }
        }

        // ================== FUNGSI USER MANAGEMENT ==================
        function showUserModal(id = null) {
            const modalTitle = document.getElementById('modal-user-title');
            const form = document.getElementById('form-user');

            if (id) {
                // Edit mode
                const userData = users.find(u => u.id == id);
                if (userData) {
                    modalTitle.textContent = 'Edit Pengguna';
                    document.getElementById('user-id').value = userData.id;
                    document.getElementById('user-nama').value = userData.full_name;
                    document.getElementById('user-username').value = userData.username;
                    document.getElementById('user-password').value = userData.password;
                    document.getElementById('form-user-role').value = userData.role;
                    document.getElementById('user-jurusan').value = userData.jurusan_id || '';
                }
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Pengguna Baru';
                form.reset();
                document.getElementById('user-id').value = '';
                document.getElementById('user-password').value = '';
            }

            // Populate jurusan dropdown
            const jurusanSelect = document.getElementById('user-jurusan');
            jurusanSelect.innerHTML = '<option value="">Pilih Jurusan</option>';
            jurusan.forEach(j => {
                const option = document.createElement('option');
                option.value = j.id;
                option.textContent = j.nama;
                jurusanSelect.appendChild(option);
            });

            // Show/hide jurusan field based on role
            const roleSelect = document.getElementById('form-user-role');
            roleSelect.addEventListener('change', function () {
                if (this.value === 'guru') {
                    jurusanSelect.parentElement.style.display = 'block';
                } else {
                    jurusanSelect.parentElement.style.display = 'none';
                    jurusanSelect.value = '';
                }
            });

            // Trigger change event if editing
            if (id) {
                setTimeout(() => {
                    roleSelect.dispatchEvent(new Event('change'));
                }, 100);
            }

            showModal('user-modal');
        }

        async function saveUser() {
            const id = document.getElementById('user-id').value;
            const nama = document.getElementById('user-nama').value.trim();
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;

            const roleElement = document.getElementById('form-user-role');
            const role = roleElement ? roleElement.value : 'ELEMENT_NOT_FOUND';

            const jurusanId = document.getElementById('user-jurusan').value;

            // DEBUGGING
            console.log('DEBUG ROLE:', {
                element: roleElement,
                tagName: roleElement ? roleElement.tagName : 'N/A',
                value: role,
                id: roleElement ? roleElement.id : 'N/A',
                duplicateCheck: document.querySelectorAll('#form-user-role').length
            });

            console.log('Saving User:', { id, nama, username, role, jurusanId });

            // PERBAIKAN: Validasi yang lebih tepat
            if (!nama || !username || !role) {
                console.error('Validation failed:', { nama, username, role });
                alert('Nama, Username, dan Role wajib diisi!');
                return;
            }

            // Password wajib untuk user baru
            if (!id && !password) {
                alert('Password wajib diisi untuk pengguna baru!');
                return;
            }

            if (role === 'guru' && !jurusanId) {
                alert('Jurusan harus dipilih untuk role Guru!');
                return;
            }

            // Cek duplikasi username
            const existingUser = users.find(u => u.username === username && u.id != parseInt(id || 0));
            if (existingUser) {
                alert('Username sudah digunakan!');
                return;
            }

            const userData = {
                full_name: nama,
                username: username,
                password: password, // Kirim password (kosong jika tidak diubah saat edit)
                role: role,
                jurusan_id: role === 'guru' ? parseInt(jurusanId) : null
            };

            if (id) {
                userData.id = parseInt(id);
                const result = await saveDataToSpreadsheet('saveUser', userData);
                if (result.success) {
                    alert('Data pengguna berhasil diperbarui!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadUsersTable();
                }
            } else {
                const result = await saveDataToSpreadsheet('saveUser', userData);
                if (result.success) {
                    alert('Data pengguna berhasil disimpan!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadUsersTable();
                }
            }

            closeModal('user-modal');
        }

        function editUser(id) {
            showUserModal(id);
        }

        async function deleteUser(id) {
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                // Cek apakah user sedang login
                if (currentUser && currentUser.id == id) {
                    alert('Tidak dapat menghapus pengguna yang sedang login!');
                    return;
                }

                // Cek apakah user admin
                if (id === 1) {
                    alert('Tidak dapat menghapus user administrator utama!');
                    return;
                }

                const result = await saveDataToSpreadsheet('deleteUser', { id: id });
                if (result.success) {
                    alert('Pengguna berhasil dihapus!');
                    // PERBAIKAN: Auto-refresh data
                    await loadDataFromSpreadsheet();
                    loadUsersTable();
                }
            }
        }

        // ================== FUNGSI SETTINGS ==================
        function loadSettings() {
            // Apply settings to UI
            applySettings();
        }

        function loadSettingsPage() {
            // Apply settings to settings page
            const appNameInput = document.getElementById('app-name');
            const schoolNameInput = document.getElementById('school-name');
            const currentLogoPreview = document.getElementById('current-logo-preview');
            const currentLogoName = document.getElementById('current-logo-name');

            if (appNameInput) appNameInput.value = settings.appName || 'PinjamAlat';
            if (schoolNameInput) schoolNameInput.value = settings.schoolName || 'SMKN 1 BUMIJAWA';

            if (currentLogoPreview) {
                if (settings.logo) {
                    currentLogoPreview.src = settings.logo;
                    currentLogoName.textContent = 'Logo Sekolah (Custom)';
                } else {
                    currentLogoPreview.src = DEFAULT_LOGO_URL; // <-- Default logo
                    currentLogoName.textContent = 'Logo Sekolah (Default)';
                }
                currentLogoPreview.style.display = 'block';
            }
        }

        function applySettings() {
            // Apply to login page
            const loginSchoolName = document.getElementById('login-school-name');
            const loginSchoolLogo = document.getElementById('login-school-logo');

            if (loginSchoolName) {
                loginSchoolName.textContent = settings.schoolName || 'SMKN 1 BUMIJAWA';
            }

            if (loginSchoolLogo) {
                if (settings.logo) {
                    loginSchoolLogo.src = settings.logo;
                } else {
                    loginSchoolLogo.style.display = DEFAULT_LOGO_URL;
                }
                loginSchoolLogo.style.display = 'block';
                loginSchoolLogo.onerror = function () {
                    console.error('Gagal memuat logo:', this.src);
                    this.src = DEFAULT_LOGO_URL; // Fallback ke logo default
                };
            }

            // Apply to sidebar
            const sidebarSchoolName = document.getElementById('sidebar-school-name');
            const sidebarLogo = document.getElementById('sidebar-logo');

            if (sidebarSchoolName) {
                sidebarSchoolName.textContent = settings.schoolName || 'PinjamAlat';
            }

            if (sidebarLogo) {
                if (settings.logo) {
                    sidebarLogo.src = settings.logo;
                } else {
                    sidebarLogo.src = DEFAULT_LOGO_URL; // <-- Default logo
                }
                sidebarLogo.style.display = 'block';
                sidebarLogo.onerror = function () {
                    console.error('Gagal memuat logo sidebar:', this.src);
                    this.src = DEFAULT_LOGO_URL; // Fallback ke logo default
                };
            }
        }

        async function saveGeneralSettings() {
            const appName = document.getElementById('app-name').value;
            const schoolName = document.getElementById('school-name').value;

            const settingsData = {
                appName: appName,
                schoolName: schoolName,
                logo: settings.logo || ''
            };

            const result = await saveDataToSpreadsheet('saveSettings', settingsData);
            if (result.success) {
                settings = settingsData;
                applySettings();
                alert('Pengaturan berhasil disimpan!');
            }
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Ukuran file terlalu besar! Maksimal 2MB.');
                return;
            }

            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                alert('Format file tidak didukung! Gunakan JPG, PNG, atau SVG.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const newLogoPreview = document.getElementById('new-logo-preview');
                const newLogoPreviewContainer = document.getElementById('new-logo-preview-container');

                if (newLogoPreview) {
                    newLogoPreview.src = e.target.result;
                    newLogoPreviewContainer.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }

        function previewLogoUrl(url) {
            if (!url) return;

            const newLogoPreview = document.getElementById('new-logo-preview');
            const newLogoPreviewContainer = document.getElementById('new-logo-preview-container');

            if (newLogoPreview) {
                newLogoPreview.src = url;
                newLogoPreviewContainer.style.display = 'block';

                // Reset file upload if any
                document.getElementById('logo-upload').value = '';
            }
        }

        async function saveLogo() {
            const newLogoPreview = document.getElementById('new-logo-preview');
            const logoUpload = document.getElementById('logo-upload');
            const logoUrlInput = document.getElementById('logo-url');

            if (logoUpload.files.length > 0) {
                const file = logoUpload.files[0];
                try {
                    const uploadResult = await uploadFoto(file);
                    if (uploadResult.success) {
                        await saveLogoSettings(uploadResult.downloadUrl);
                    } else {
                        alert('Gagal mengunggah logo: ' + uploadResult.message);
                    }
                } catch (error) {
                    alert('Gagal mengunggah logo: ' + error.message);
                }
            } else if (logoUrlInput && logoUrlInput.value) {
                await saveLogoSettings(logoUrlInput.value);
            } else {
                alert('Pilih logo atau masukkan URL terlebih dahulu!');
            }
        }

        async function saveLogoSettings(url) {
            settings.logo = url;

            const settingsData = {
                appName: settings.appName || 'PinjamAlat',
                schoolName: settings.schoolName || 'SMKN 1 BUMIJAWA',
                logo: settings.logo
            };

            const result = await saveDataToSpreadsheet('saveSettings', settingsData);
            if (result.success) {
                applySettings();

                // Reset preview
                const newLogoPreviewContainer = document.getElementById('new-logo-preview-container');
                newLogoPreviewContainer.style.display = 'none';
                document.getElementById('logo-upload').value = '';
                if (document.getElementById('logo-url')) {
                    document.getElementById('logo-url').value = '';
                }

                alert('Logo berhasil disimpan!');
            }
        }

        function setDefaultLogo(logoType) {

            if (logoType === 'remove') {
                settings.logo = null; // Akan menggunakan default
            } else {
                // Default logo URLs (simplified for demo)
                const defaultLogos = {
                    logo1: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMTIiIGZpbGw9IiM0MzYxRUUiLz4KPHBhdGggZD0iTTQ1IDM1TDU1IDM1TDU1IDY1TDQ1IDY1WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTM1IDQ1TDY1IDQ1TDY1IDU1TDM1IDU1WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                    logo2: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjQwIiBmaWxsPSIjNDM2MUVFIi8+CjxwYXRoIGQ9Ik01NSA0MEw2NSA0MEw2NSA2MEw1NSA2MFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zNSA0MEw0NSA0MEw0NSA2MEwzNSA2MFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik00NSA2NUw1NSA2NUw1NSA3NUw0NSA3NVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==',
                    logo3: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjAiIGZpbGw9IiM0MzYxRUUiLz4KPHBhdGggZD0iTTMwIDQwTDcwIDQwTDcwIDYwTDMwIDYwWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTQ1IDY1TDU1IDY1TDU1IDgwTDQ1IDgwWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+'
                };

                settings.logo = defaultLogos[logoType];
            }

            applySettings();
            alert('Logo berhasil diterapkan!');
        }

        function openUserGuide() {
            alert('Panduan penggunaan akan dibuka di tab baru.');
            // window.open('panduan.pdf', '_blank'); // Uncomment jika ada file panduan
        }

        // ================== FUNGSI FILTER ==================
        function filterAlatTable() {
            const kategoriFilter = document.getElementById('filter-kategori').value;
            const jurusanFilter = document.getElementById('filter-jurusan').value;
            const kondisiFilter = document.getElementById('filter-kondisi').value;
            const tersediaFilter = document.getElementById('filter-tersedia').value;
            const searchFilter = document.getElementById('search-alat').value.toLowerCase();

            let filteredAlat = alat;

            // Filter by current user's jurusan if not superuser
            if (currentUser && currentUser.role !== 'superuser' && currentUser.jurusan_id) {
                filteredAlat = filteredAlat.filter(a => a.jurusan_id == currentUser.jurusan_id);
            }

            // Apply filters
            if (kategoriFilter !== 'all') {
                filteredAlat = filteredAlat.filter(a => a.kategori_id == kategoriFilter);
            }

            if (jurusanFilter !== 'all') {
                filteredAlat = filteredAlat.filter(a => a.jurusan_id == jurusanFilter);
            }

            if (kondisiFilter !== 'all') {
                filteredAlat = filteredAlat.filter(a => a.kondisi === kondisiFilter);
            }

            if (tersediaFilter !== 'all') {
                if (tersediaFilter === 'tersedia') {
                    filteredAlat = filteredAlat.filter(a => a.jumlah_tersedia > 0);
                } else if (tersediaFilter === 'dipinjam') {
                    filteredAlat = filteredAlat.filter(a => a.jumlah_tersedia < a.jumlah_total);
                }
            }

            // Apply search
            if (searchFilter) {
                filteredAlat = filteredAlat.filter(a =>
                    a.kode_seri.toLowerCase().includes(searchFilter) ||
                    a.nama.toLowerCase().includes(searchFilter)
                );
            }

            // Update count
            document.getElementById('alat-count').textContent = filteredAlat.length;

            // Update desktop table
            const tbody = document.querySelector('#alat-table tbody');
            if (tbody) {
                tbody.innerHTML = '';

                filteredAlat.forEach(a => {
                    const kategoriData = kategori.find(k => k.id == a.kategori_id);
                    const kategoriNama = kategoriData ? kategoriData.nama : '-';

                    const jurusanData = jurusan.find(j => j.id == a.jurusan_id);
                    const jurusanNama = jurusanData ? jurusanData.nama : '-';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${a.foto ?
                            `<img src="${a.foto}" class="alat-thumbnail" alt="${a.nama}">` :
                            `<div class="alat-thumbnail" style="background: var(--gradient-primary); color: white; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-tools"></i>
                                </div>`
                        }
                        </td>
                        <td>${a.kode_seri}</td>
                        <td>${a.nama}</td>
                        <td>${kategoriNama}</td>
                        <td>${jurusanNama}</td>
                        <td>${a.jumlah_total}</td>
                        <td>${a.jumlah_tersedia}</td>
                        <td><span class="badge ${getKondisiBadgeClass(a.kondisi)}">${a.kondisi}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" onclick="showAlatModal(${a.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAlat(${a.id})" ${a.jumlah_tersedia < a.jumlah_total ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Update mobile view if on mobile
            if (window.innerWidth <= 768) {
                updateAlatTableMobile(filteredAlat);
            }
        }

        function updateAlatTableMobile(filteredAlat) {
            const container = document.getElementById('alat-table-mobile');
            if (!container) return;

            container.innerHTML = '';

            if (filteredAlat.length === 0) {
                container.innerHTML = '<div class="mobile-table-item" style="text-align: center; color: var(--gray);">Tidak ada data alat</div>';
                return;
            }

            filteredAlat.forEach(a => {
                const kategoriData = kategori.find(k => k.id == a.kategori_id);
                const kategoriNama = kategoriData ? kategoriData.nama : '-';

                const jurusanData = jurusan.find(j => j.id == a.jurusan_id);
                const jurusanNama = jurusanData ? jurusanData.nama : '-';

                const item = document.createElement('div');
                item.className = 'mobile-table-item';

                const actions = `
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-sm btn-info" onclick="showAlatModal(${a.id})" style="flex: 1;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlat(${a.id})" ${a.jumlah_tersedia < a.jumlah_total ? 'disabled' : ''} style="flex: 1;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;

                item.innerHTML = `
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kode Seri</span>
                        <span class="mobile-table-value">${a.kode_seri}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Nama Alat</span>
                        <span class="mobile-table-value">${a.nama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kategori</span>
                        <span class="mobile-table-value">${kategoriNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jurusan</span>
                        <span class="mobile-table-value">${jurusanNama}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Jumlah</span>
                        <span class="mobile-table-value">${a.jumlah_tersedia}/${a.jumlah_total}</span>
                    </div>
                    <div class="mobile-table-row">
                        <span class="mobile-table-label">Kondisi</span>
                        <span class="mobile-table-value"><span class="badge ${getKondisiBadgeClass(a.kondisi)}">${a.kondisi}</span></span>
                    </div>
                    ${actions}
                `;

                container.appendChild(item);
            });
        }

        // ================== FUNGSI KAMERA ==================
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function (s) {
                        stream = s;
                        const video = document.getElementById('camera-preview');
                        video.srcObject = stream;
                        video.play();

                        // Show stop button
                        document.querySelector('#camera-container button:nth-child(2)').style.display = 'inline-block';
                    })
                    .catch(function (err) {
                        console.error('Error accessing camera:', err);
                        alert('Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.');
                    });
            } else {
                alert('Browser tidak mendukung akses kamera.');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                const video = document.getElementById('camera-preview');
                video.srcObject = null;

                // Hide stop button
                document.querySelector('#camera-container button:nth-child(2)').style.display = 'none';
            }
        }

        // ================== FUNGSI EKSPOR ==================
        function exportAlatToExcel() {
            alert('Fitur ekspor Excel untuk data alat');
        }

        function exportAlatToPDF() {
            alert('Fitur ekspor PDF untuk data alat');
        }

        function exportRiwayatToExcel() {
            alert('Fitur ekspor Excel untuk riwayat');
        }

        function exportRiwayatToPDF() {
            alert('Fitur ekspor PDF untuk riwayat');
        }

        function exportKategoriToExcel() {
            alert('Fitur ekspor Excel untuk kategori');
        }

        function exportKategoriToPDF() {
            alert('Fitur ekspor PDF untuk kategori');
        }

        function exportJurusanToExcel() {
            alert('Fitur ekspor Excel untuk jurusan');
        }

        function exportJurusanToPDF() {
            alert('Fitur ekspor PDF untuk jurusan');
        }

        function exportUsersToExcel() {
            alert('Fitur ekspor Excel untuk users');
        }

        function exportUsersToPDF() {
            alert('Fitur ekspor PDF untuk users');
        }

        // ================== PASSWORD TOGGLE ==================
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('password-toggle-icon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // ================== LOGO LOADING ==================
        async function loadLogoOnInit() {
            const DEFAULT_LOGO = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZs7SGoRoibsRUkeVfMPcmjXotJL7Q0JoXJw6fU6mQt2Ez88VVuY39eJG97DX4_p-WIfwmjAZEvCsvTXu3wYNZOzQpmoPJ6D5pptrlQO8hGOEDclFmEW5Sa6Wq6G0BlE0BjySPARQWLojr3vU2i1x8SunVWuFJv1KCcVv30zaJ8MLZZP1o-6-cdDW0Sa4/s320/smk-02.png';

            try {
                const result = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getSettings' })
                });

                const data = await result.json();

                // Use logo from settings or default logo
                const logoUrl = (data.success && data.data.logo) ? data.data.logo : DEFAULT_LOGO;

                // Update logo di login page
                const loginLogo = document.getElementById('login-school-logo');
                if (loginLogo) {
                    loginLogo.src = logoUrl;
                    loginLogo.style.display = 'block';
                }

                // Update school name
                if (data.success && data.data.schoolName) {
                    const loginSchoolName = document.getElementById('login-school-name');
                    if (loginSchoolName) {
                        loginSchoolName.textContent = data.data.schoolName;
                    }
                }
            } catch (error) {
                console.error('Error loading logo:', error);
                // Use default logo on error
                const loginLogo = document.getElementById('login-school-logo');
                if (loginLogo) {
                    loginLogo.src = DEFAULT_LOGO;
                    loginLogo.style.display = 'block';
                }
            }
        }

        // ================== INISIALISASI APLIKASI ==================
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });
    </script>
</body>

</html>
